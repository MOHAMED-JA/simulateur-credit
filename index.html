
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulateur de Cr√©dit en Dinars Tunisien</title>
  <style>
    :root{
      /* Palette futuriste rouge et bleu - Mode clair */
      --bg: #f8fafc;
      --text: #0f172a;
      --muted: #64748b;
      /* Couleurs principales : bleu √©lectrique et rouge n√©on */
      --primary: #0ea5e9;        /* bleu √©lectrique */
      --primary-2: #3b82f6;      /* bleu ciel */
      /* Couleurs d'accent : rouge n√©on et bleu profond */
      --accent: #ef4444;         /* rouge n√©on */
      --danger: #dc2626;         /* rouge fonc√© */
      /* Reste des variables */
      --border: rgba(0,0,0,.12);
      --shadow: 0 12px 32px rgba(0,0,0,.08);
      --track: #e5e7eb;
      --thumb: #c084fc;          /* pouce violet clair pour la barre de d√©filement */
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      /* Fond clair futuriste : d√©grad√© subtil bleu clair vers rose p√¢le */
      background: linear-gradient(135deg, #f0f9ff 0%, #eff6ff 33%, #fce7f3 66%, #fff1f2 100%);
      background-attachment: fixed;
      padding: 16px;
      min-height: 100vh;
    }
    .wrap{
      max-width:1360px;
      margin:0 auto;
      display:flex;
      flex-wrap:wrap;
      gap:16px;
    }
    .panel{
      /* Panneau principal avec effet verre clair et contour lumineux */
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border: 2px solid rgba(14, 165, 233, 0.5);
      box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
      border-radius:20px;
      padding: 18px;
      /* Chaque panneau occupe toute la largeur par d√©faut ; la flex-basis sera ajust√©e via media query */
      flex: 1 1 100%;
    }
    .panel-header{
      text-align:center;
      margin-bottom:8px;
      /* Encadrement interactif avec animation RGB */
      background: linear-gradient(270deg, #0ea5e9, #ef4444, #3b82f6, #dc2626, #0ea5e9);
      background-size: 400% 400%;
      animation: rgbShift 8s ease infinite;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 25px rgba(14, 165, 233, 0.5);
      border-radius:14px;
      padding:12px;
      /* Permet d'ancrer des √©l√©ments en position absolue (ex : interrupteur th√®me) */
      position: relative;
    }
    h1{ margin:0; font-size:2rem; color:#ffffff; text-shadow: 0 2px 8px rgba(0,0,0,0.3) }
    .sub{ color:#ffffff; font-size:.85rem; text-shadow: 0 1px 4px rgba(0,0,0,0.3) }

    .grid{ display:grid; grid-template-columns: 0.95fr 1.7fr; gap:16px; margin-top:12px }
    @media (max-width:1100px){ .grid{ grid-template-columns: 1fr } }

    .card{
      /* Cartes claires avec contours lumineux */
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(239, 68, 68, 0.5);
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
      border-radius:14px;
      padding:14px;
    }
    label{
      display:block;
      margin-bottom:6px;
      font-weight:700;
      color:var(--primary);
      letter-spacing:.3px;
      text-transform:uppercase;
      font-size:.8rem;
    }
    .control{ margin-bottom:12px }
    input{
      width:100%;
      padding:11px 12px;
      border-radius:10px;
      border: 2px solid rgba(14, 165, 233, 0.6);
      background: rgba(255, 255, 255, 0.95);
      color: #0f172a;
      font-variant-numeric:tabular-nums;
      box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
      transition: all 0.3s ease;
    }
    input:focus{
      outline: none;
      border-color: rgba(239, 68, 68, 0.8);
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
    }
    input[readonly]{
      /* Champ d√©sactiv√© avec style futuriste */
      background: rgba(241, 245, 249, 0.9);
      color: #94a3b8;
      border-color: rgba(100, 116, 139, 0.4);
      box-shadow: none;
    }

    .btns{ display:flex; gap:8px; flex-wrap:wrap }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-weight:800;
      background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
      box-shadow: 0 0 15px rgba(14, 165, 233, 0.5);
      transition:transform .1s ease;
    }
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .btn.secondary{ 
      background: linear-gradient(135deg, #475569, #64748b); 
      color: #e0e7ff;
      box-shadow: 0 0 10px rgba(100, 116, 139, 0.4);
    }
.btn.accent{
      /* Bouton accent en rouge n√©on pour mettre en valeur certaines actions */
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #ffffff;
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
    }
.btn.danger{
      /* Bouton danger rouge vif avec l√©ger d√©grad√© */
      background: linear-gradient(135deg, #dc2626, #991b1b);
      color: #fff;
      box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
    }

/* ===== Animation pour le bouton Calculer ===== */
/* Le d√©grad√© change de couleur en continu¬†: bleu ‚Üí rouge ‚Üí violet ‚Üí jaune */
@keyframes rgbShift {
  0%   { background-position: 0% 50%; }
  50%  { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
.btn.rgb {
  background: linear-gradient(270deg, #0ea5e9, #ef4444, #3b82f6, #dc2626);
  background-size: 800% 800%;
  color: #fff;
  animation: rgbShift 12s linear infinite;
  box-shadow: 0 0 20px rgba(14, 165, 233, 0.6);
}

    .kpis{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px }
    .kpi{
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(6px);
      border: 2px solid rgba(14, 165, 233, 0.5);
      border-radius:10px;
      padding:10px;
      box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
    }
    .kpi .title{
      color:var(--muted);
      font-size:.82rem;
    }
    .kpi .value{
      font-size:1.4rem;
      font-weight:900;
      color:var(--primary);
    }

    /*
      Styles sp√©cifiques pour les cellules KPI (Mensualit√© et Co√ªt total des int√©r√™ts).
      Chaque valeur est mise en avant avec un fond d√©grad√© color√© et un texte contrast√©.
      Ces couleurs s'ajustent automatiquement via les variables CSS d√©finies en fonction du mode clair/sombre.
    */
    #kpiMensualite{
      /* Pour la mensualit√©¬†: d√©grad√© bleu‚Äëviolet inspir√© de nos couleurs primaires */
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color: #ffffff;
      padding: 4px 10px;
      border-radius: 8px;
      display: inline-block;
      min-width: 100%;
    }
    #kpiInterets{
      /* Pour le co√ªt total des int√©r√™ts¬†: d√©grad√© jaune‚Äërouge utilisant l'accent et le danger */
      background: linear-gradient(135deg, var(--accent), var(--danger));
      color: #0f172a;
      padding: 4px 10px;
      border-radius: 8px;
      display: inline-block;
      min-width: 100%;
    }
    /* Les sc√©narios suppl√©mentaires utilisent les m√™mes couleurs que le premier sc√©nario
       pour mettre en valeur les indicateurs cl√©s (Mensualit√© et Co√ªt total des int√©r√™ts).
       On applique donc exactement les m√™mes d√©grad√©s et styles aux cellules du
       deuxi√®me sc√©nario afin d'assurer la coh√©rence visuelle. */
    #kpiMensualite2{
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color: #ffffff;
      padding: 4px 10px;
      border-radius: 8px;
      display: inline-block;
      min-width: 100%;
    }
    #kpiInterets2{
      background: linear-gradient(135deg, var(--accent), var(--danger));
      color: #0f172a;
      padding: 4px 10px;
      border-radius: 8px;
      display: inline-block;
      min-width: 100%;
    }
    /* En mode sombre, l'arri√®re‚Äëplan g√©n√©ral change mais le d√©grad√© des KPI reste lumineux.
       On conserve donc la m√™me couleur de texte pour garantir un contraste suffisant. */
    body.dark #kpiMensualite{
      color:#ffffff;
    }
    body.dark #kpiInterets{
      color:#0f172a;
    }

    /* En mode sombre, conserver le contraste pour les indicateurs du deuxi√®me sc√©nario. */
    body.dark #kpiMensualite2{
      color:#ffffff;
    }
    body.dark #kpiInterets2{
      color:#0f172a;
    }

    /* ===== Table area: fixed height + always scrollable vertically ===== */
    .table-shell{
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(239, 68, 68, 0.5);
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
      border-radius:14px;
      padding:12px;
      display:flex;
      flex-direction:column;
    }
    .table-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }
    .table-wrap{
      border-radius:10px; overflow-y:auto; overflow-x:auto; flex:1 1 auto;
      max-height:72vh;  /* fixed visible area to force vertical scroll */
      scrollbar-gutter: stable both-edges;
    }
    /* Custom scrollbar */
    .table-wrap::-webkit-scrollbar { width: 12px; height: 12px; }
    .table-wrap::-webkit-scrollbar-track { background: var(--track); border-radius:12px }
    .table-wrap::-webkit-scrollbar-thumb { background: var(--thumb); border-radius:12px }
    .table-wrap{ scrollbar-color: var(--thumb) var(--track); } /* Firefox */

    /* ===== Compact colonnes redimensionn√©es ===== */
    table{ width:100%; border-collapse:collapse; min-width: 700px; table-layout: fixed; font-variant-numeric:tabular-nums }
    colgroup col.month{ width: 60px }
    colgroup col.pay{ width: 120px }
    colgroup col.int{ width: 100px }
    colgroup col.prin{ width: 100px }
    colgroup col.rem{ width: 150px }
    thead th{
      position:sticky;
      top:0;
      /* Fond d√©grad√© anim√© bleu et rouge */
      background: linear-gradient(270deg, #0ea5e9, #ef4444, #3b82f6, #dc2626, #0ea5e9);
      background-size: 400% 400%;
      animation: rgbShift 8s ease infinite;
      backdrop-filter: blur(6px);
      color: #ffffff;
      font-weight: 800;
      text-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
      text-align:right;
      padding:12px;
      white-space:nowrap;
      font-size:14px;
      transition: all 0.3s ease;
    }
    /* Effet interactif au survol */
    thead th:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5);
    }
    thead th:first-child, tbody td:first-child{ text-align:left }
    tbody td{
      padding:10px;
      border: 1px solid rgba(14, 165, 233, 0.3);
      text-align:right;
      color: #0f172a;
      white-space:nowrap;
      font-size:14px;
    }
    tbody tr:hover td{ 
      background: rgba(14, 165, 233, 0.2);
      box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
    }
    
    /* Masquer thead et tfoot par d√©faut */
    #table thead,
    #table tfoot,
    #table2 thead,
    #table2 tfoot {
      display: none;
    }
    
    /* Afficher thead et tfoot quand la classe 'show-headers' est pr√©sente */
    #table.show-headers thead,
    #table.show-headers tfoot,
    #table2.show-headers thead,
    #table2.show-headers tfoot {
      display: table-header-group;
    }
    
    #table.show-headers tfoot,
    #table2.show-headers tfoot {
      display: table-footer-group;
    }
    
    /* Style pour la ligne Total */
    tfoot td{
      padding:12px 10px;
      border: 2px solid rgba(14, 165, 233, 0.5);
      text-align:right;
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.15), rgba(239, 68, 68, 0.15));
      color: #0f172a;
      white-space:nowrap;
      font-size:15px;
      font-weight: 700;
    }
    tfoot td:first-child{
      text-align:left;
      font-weight: 900;
      font-size:16px;
      color: #0ea5e9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tfoot td .total-value{
      font-weight: 900;
      font-size:16px;
      color: #dc2626;
    }

    /* Bouton Export Excel en vert */
    #btnExportXLSX{
      background: linear-gradient(135deg,#059669,#10b981);
      color:#fff;
    }
    #btnExportXLSX:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    
    /* Bouton Export PDF en orange */
    #btnExportPDF, #btnExportPDF2{
      background: linear-gradient(135deg,#f97316,#ea580c);
      color:#fff;
      box-shadow: 0 0 15px rgba(249, 115, 22, 0.4);
    }
    #btnExportPDF:hover, #btnExportPDF2:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(249, 115, 22, 0.5);
    }

    /* Appliquer le m√™me style vert au bouton d'export Excel du deuxi√®me sc√©nario.
       Sans cette r√®gle, ce bouton reprendrait la couleur par d√©faut des boutons
       et se distinguerait visuellement de l'export du premier sc√©nario. */
    #btnExportXLSX2{
      background: linear-gradient(135deg,#059669,#10b981);
      color:#fff;
    }
    #btnExportXLSX2:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    /* Lien LinkedIn */
    .linkedin-link{
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:var(--primary);
      text-decoration:none;
      font-weight:700;
    }
    .linkedin-link:hover{
      text-decoration:underline;
    }
    .linkedin-link svg{
      width:16px;
      height:16px;
      fill:var(--primary);
    }

    /* ===== Composants pour le changement de th√®me (clair ‚Üî sombre) ===== */
    .theme-toggle{
      position:absolute;
      top:12px;
      right:12px;
    }
    .theme-toggle .switch{
      position:relative;
      display:inline-block;
      width:46px;
      height:24px;
    }
    .theme-toggle .switch input{
      opacity:0;
      width:0;
      height:0;
    }
    .theme-toggle .slider{
      position:absolute;
      cursor:pointer;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:var(--track);
      transition:.4s;
      border-radius:34px;
    }
    .theme-toggle .slider:before{
      position:absolute;
      content:"";
      height:18px;
      width:18px;
      left:3px;
      bottom:3px;
      background-color:#fff;
      transition:.4s;
      border-radius:50%;
    }
    .theme-toggle input:checked + .slider{
      background:var(--primary);
    }
    .theme-toggle input:checked + .slider:before{
      transform:translateX(22px);
    }

    /* Mode sombre : change les variables CSS et le fond */
    body.dark{
      --bg: #0f172a;
      --text: #f8fafc;
      --muted: #94a3b8;
      --primary: #0ea5e9;        /* bleu √©lectrique */
      --primary-2: #3b82f6;      /* bleu ciel */
      --accent: #ef4444;         /* rouge n√©on */
      --danger: #dc2626;         /* rouge fonc√© */
      --border: rgba(255,255,255,0.12);
      --shadow: 0 12px 32px rgba(0,0,0,0.5);
      --track: #1e293b;
      --thumb: #334155;
      /* Fond sombre futuriste : d√©grad√© bleu profond vers violet sombre */
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 33%, #312e81 66%, #1e293b 100%);
    }

    /* Styles suppl√©mentaires pour le mode sombre afin d'assurer la lisibilit√© */
    body.dark .panel{
      background: rgba(15, 23, 42, 0.7);
      border: 2px solid rgba(14, 165, 233, 0.5);
      box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
    }
    body.dark .panel-header{
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(14, 165, 233, 0.6);
      box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);
    }
    body.dark .card{
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(239, 68, 68, 0.5);
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
    }
    body.dark .table-shell{
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(239, 68, 68, 0.5);
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
    }
    body.dark .kpi{
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(14, 165, 233, 0.5);
      box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
    }
    body.dark #chartContainer.card{
      background: rgba(15, 23, 42, 0.8);
      border: 2px solid rgba(239, 68, 68, 0.5);
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
    }
    body.dark input{
      background: rgba(30, 41, 59, 0.9);
      color: #e0e7ff;
      border: 2px solid rgba(14, 165, 233, 0.6);
      box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
    }
    body.dark input[readonly]{
      background: rgba(30, 41, 59, 0.5);
      color: #64748b;
      border-color: rgba(100, 116, 139, 0.4);
      box-shadow: none;
    }
    body.dark .btn.secondary{
      background: linear-gradient(135deg, #475569, #64748b);
      color: #e0e7ff;
      box-shadow: 0 0 10px rgba(100, 116, 139, 0.4);
    }

    body.dark thead th{
      background: rgba(15, 23, 42, 0.9);
      color: #0ea5e9;
      border: 1px solid rgba(14, 165, 233, 0.3);
    }
    body.dark tbody td{
      color: #e0e7ff;
      border-bottom:1px dashed rgba(14, 165, 233, 0.2);
    }
    body.dark tbody tr:hover td{
      background: rgba(14, 165, 233, 0.2);
      box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
    }

    /* Boutons accent en mode sombre gardent le style rouge n√©on */
    body.dark .btn.accent{
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #ffffff;
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
    }

    /* Permet d'afficher plusieurs panneaux c√¥te √† c√¥te lorsque l'espace le permet. */
    @media (min-width: 1100px){
      .panel{
        flex: 1 1 calc(50% - 16px);
      }
    }

    /* Container optionnel pour plusieurs sc√©narios (non utilis√© mais laiss√© pour extensibilit√©). */
    .scenarios{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
    }
    .scenarios .panel{
      flex:1 1 100%;
    }
    @media (min-width: 1100px){
      .scenarios .panel{
        flex:1 1 calc(50% - 16px);
      }
    }
  
  /* Orange style for the "R√©duire taux (si √©ligible)" button */
  .btn.orange{
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%) !important;
    color: #ffffff !important;
    border: none !important;
    box-shadow: 0 10px 25px rgba(249, 115, 22, 0.35) !important;
  }
  .btn.orange:hover{
    filter: brightness(1.05);
    transform: translateY(-1px);
  }
  .dark .btn.orange{
    background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
    color: #111827;
    box-shadow: 0 10px 25px rgba(245, 158, 11, 0.35);
  }
</style>

<!-- SheetJS pour g√©n√©rer des .xlsx c√¥t√© navigateur -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Chart.js pour les graphiques interactifs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF pour g√©n√©rer des PDF c√¥t√© navigateur -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- jsPDF autoTable pour les tableaux dans les PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="panel-header">
        <h1>Simulateur de Cr√©dit en Dinars Tunisien</h1>
        <div class="sub">
          Application faite par
          <a class="linkedin-link" href="https://www.linkedin.com/in/mohamed-aziz-jaouadi-%C2%AEpsm-i-%C2%AEpspo-l-%C2%AEistqb-851009115/" target="_blank">
            <!-- Ic√¥ne LinkedIn -->
            <svg viewBox="0 0 24 24">
              <path d="M20.447 20.452h-3.93v-5.569c0-1.327-.024-3.036-1.849-3.036-1.851 0-2.134 1.447-2.134 2.942v5.663h-3.93V9h3.77v1.561h.054c.525-0.998 1.807-2.049 3.721-2.049 3.979 0 4.713 2.618 4.713 6.018v6.922h-.001zM5.337 7.433c-1.27 0-2.297-1.026-2.297-2.295 0-1.269 1.028-2.296 2.297-2.296 1.27 0 2.297 1.027 2.297 2.296 0 1.269-1.028 2.295-2.297 2.295zm1.967 13.019H3.37V9h3.934v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.732v20.535C0 23.227.792 24 1.771 24h20.451c.979 0 1.772-.773 1.772-1.732V1.732C23.998.774 23.205 0 22.225 0z"/>
            </svg>
            Mohamed&nbsp;Aziz&nbsp;Jaouadi
          </a>
        </div>
        <!-- Interrupteur mode clair/sombre -->
        <div class="theme-toggle">
          <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="grid">
        <section class="card">
          <div class="control">
            <label for="capital">Capital emprunt√© (TND)</label>
            <input type="number" id="capital" min="0" step="0.001" value="0">
          </div>
          <div class="control">
            <label for="annee">Dur√©e (en ann√©es)</label>
            <input type="number" id="annee" min="0" max="25" step="0.1" value="" placeholder="Saisir les ann√©es">
          </div>
          <div class="control">
            <label for="duree">Dur√©e (en mois, 1‚Äì300)</label>
            <input type="number" id="duree" min="1" max="300" step="1" value="1" readonly>
            <div id="warnDuree" class="warning" style="color:#b91c1c; display:none">La dur√©e doit √™tre comprise entre 1 et 300 mois.</div>
          </div>
          <div class="control">
            <label for="tauxAnnuel">Taux d'int√©r√™t annuel (%)</label>
            <input type="number" id="tauxAnnuel" min="0" step="0.001" value="0">
          </div>
          <div class="control">
            <label for="tauxMensuel">Taux d'int√©r√™t mensuel</label>
            <input type="number" id="tauxMensuel" step="0.000001" readonly>
          </div>
          <div class="control">
            <label for="dateDebut">Date de d√©but du cr√©dit</label>
            <input type="date" id="dateDebut" value="${new Date().toISOString().substring(0, 10)}">
          </div>

          <div class="btns">
            <button class="btn rgb" id="btnCalcul">Calculer</button>
            <button class="btn secondary" id="btnReset">R√©initialiser</button>
            <button class="btn orange" id="btnReducTaux" title="Diviser le taux si conditions remplies">R√©duire taux (si √©ligible)</button>
          </div>
          
          <div class="btns" style="margin-top: 12px;">
            <button class="btn" id="btnCapacite" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); width: 100%;">üí∞ Capacit√© d'emprunt</button>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="title">Mensualit√©</div>
              <div class="value" id="kpiMensualite">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="title">Co√ªt total des int√©r√™ts</div>
              <div class="value" id="kpiInterets">‚Äî</div>
            </div>
          </div>
        </section>

        <section class="table-shell">
          <div class="table-actions">
            <button class="btn accent" id="btnGen">G√©n√©rer l'amortissement</button>
            <button class="btn" id="btnExportXLSX">Exporter Excel (.xlsx)</button>
            <button class="btn" id="btnExportPDF">Exporter PDF</button>
            <button class="btn" id="btnEmail" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: #fff; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);">üìß Partager par Email</button>
            <button class="btn" id="btnHistorique" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #fff; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);">üìú Historique</button>
            <button class="btn accent" id="btnToggleChart">Graphique</button>
            <!-- Interrupteur pour basculer entre affichage mensuel et annuel -->
            <button class="btn" id="btnTogglePeriod">Affichage: Annuel</button>
            <!-- Ajoute un deuxi√®me sc√©nario pour comparer les pr√™ts -->
            <button class="btn" id="btnAddScenario">Ajouter un sc√©nario</button>
            <button class="btn" id="btnComparer" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);">üîç Comparer 3 sc√©narios</button>
          </div>
          <div class="table-wrap">
            <table id="table">
              <colgroup>
                <col class="month"><col class="pay"><col class="int"><col class="prin"><col class="rem">
              </colgroup>
              <thead>
                <tr>
                  <th>P√©riode</th>
                  <th>Mensualit√©</th>
                  <th>Int√©r√™ts</th>
                  <th>Principal</th>
                  <th>Capital restant d√ª</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td><span class="total-value" id="totalMensualite">‚Äî</span></td>
                  <td><span class="total-value" id="totalInterets">‚Äî</span></td>
                  <td><span class="total-value" id="totalPrincipal">‚Äî</span></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </section>
      </div>
      <!-- Conteneur pour le graphique d'amortissement -->
      <div id="chartContainer" class="card" style="display:none; margin-top:16px;">
        <canvas id="amortChart" height="350"></canvas>
      </div>
    </div>
    <!-- Scenario 2: second simulation panel (initialement masqu√©) -->
    <div id="scenario2" class="panel" style="display:none;">
      <div class="panel-header">
        <h1>Sc√©nario¬†2</h1>
      </div>
      <div class="grid">
        <section class="card">
          <div class="control">
            <label for="capital2">Capital emprunt√© (TND)</label>
            <input type="number" id="capital2" min="0" step="0.001" value="0">
          </div>
          <div class="control">
            <label for="annee2">Dur√©e (en ann√©es)</label>
            <input type="number" id="annee2" min="0" max="25" step="0.1" value="" placeholder="Saisir les ann√©es">
          </div>
          <div class="control">
            <label for="duree2">Dur√©e (en mois, 1‚Äì300)</label>
            <input type="number" id="duree2" min="1" max="300" step="1" value="1" readonly>
            <div id="warnDuree2" class="warning" style="color:#b91c1c; display:none">La dur√©e doit √™tre comprise entre 1 et 300 mois.</div>
          </div>
          <div class="control">
            <label for="tauxAnnuel2">Taux d'int√©r√™t annuel (%)</label>
            <input type="number" id="tauxAnnuel2" min="0" step="0.001" value="0">
          </div>
          <div class="control">
            <label for="tauxMensuel2">Taux d'int√©r√™t mensuel</label>
            <input type="number" id="tauxMensuel2" step="0.000001" readonly>
          </div>
          <div class="control">
            <label for="dateDebut2">Date de d√©but du cr√©dit</label>
            <input type="date" id="dateDebut2" value="${new Date().toISOString().substring(0, 10)}">
          </div>
          <div class="btns">
            <button class="btn rgb" id="btnCalcul2">Calculer</button>
            <button class="btn secondary" id="btnReset2">R√©initialiser</button>
          </div>
          <div class="kpis">
            <div class="kpi">
              <div class="title">Mensualit√©</div>
              <div class="value" id="kpiMensualite2">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="title">Co√ªt total des int√©r√™ts</div>
              <div class="value" id="kpiInterets2">‚Äî</div>
            </div>
          </div>
        </section>
        <section class="table-shell">
          <div class="table-actions">
            <button class="btn accent" id="btnGen2">G√©n√©rer l'amortissement</button>
            <button class="btn" id="btnExportXLSX2">Exporter Excel (.xlsx)</button>
            <button class="btn" id="btnExportPDF2">Exporter PDF</button>
            <button class="btn accent" id="btnToggleChart2">Graphique</button>
            <button class="btn" id="btnTogglePeriod2">Affichage: Annuel</button>
            <!-- Bouton supprim√© du sc√©nario 2 -->
          </div>
          <div class="table-wrap">
            <table id="table2">
              <colgroup>
                <col class="month"><col class="pay"><col class="int"><col class="prin"><col class="rem">
              </colgroup>
              <thead>
                <tr>
                  <th>P√©riode</th>
                  <th>Mensualit√©</th>
                  <th>Int√©r√™ts</th>
                  <th>Principal</th>
                  <th>Capital restant d√ª</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td>Total</td>
                  <td><span class="total-value" id="totalMensualite2">‚Äî</span></td>
                  <td><span class="total-value" id="totalInterets2">‚Äî</span></td>
                  <td><span class="total-value" id="totalPrincipal2">‚Äî</span></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </section>
      </div>
      <div id="chartContainer2" class="card" style="display:none; margin-top:16px;">
        <canvas id="amortChart2" height="350"></canvas>
      </div>
    </div>

  <script>
    const PREC = 3;
    const el = id => document.getElementById(id);
    const fmtMoney = v => new Intl.NumberFormat('fr-FR',{ style:'currency', currency:'TND', minimumFractionDigits:PREC, maximumFractionDigits:PREC }).format(v);
    const fmtNum = (v, d=6) => Number(v).toFixed(d);

    const capital = el('capital');
    const annee = el('annee');
    const duree = el('duree');
    const tauxAnnuel = el('tauxAnnuel');
    const tauxMensuel = el('tauxMensuel');
    const warnDuree = el('warnDuree');
    const kpiMensualite = el('kpiMensualite');
    const kpiInterets = el('kpiInterets');
    const tableBody = document.querySelector('#table tbody');

    // Fonction pour convertir les ann√©es en mois (le champ mois reste toujours readonly)
    function updateDureeFromAnnee(){
      const anneeVal = parseFloat(annee.value || '0');
      if(anneeVal > 0){
        const mois = Math.round(anneeVal * 12);
        if(mois >= 1 && mois <= 300){
          duree.value = mois;
        } else {
          // Si le r√©sultat est hors limites, r√©initialiser
          annee.value = '';
          duree.value = 1;
          alert('La dur√©e en mois doit rester entre 1 et 300 mois (0.08 √† 25 ann√©es)');
        }
      } else {
        // Si le champ ann√©e est vide, r√©initialiser √† 1 mois
        duree.value = 1;
      }
    }

    // Fonction pour supprimer les z√©ros √† gauche des inputs num√©riques
    function removeLeadingZeros(inputElement){
      if(inputElement && inputElement.type === 'number'){
        let val = inputElement.value;
        if(val && val.length > 0){
          // Convertir en nombre puis retour en string pour √©liminer les z√©ros
          const num = parseFloat(val);
          if(!isNaN(num)){
            inputElement.value = num;
          }
        }
      }
    }

    // Attacher les √©v√©nements
    if(annee){
      annee.addEventListener('input', updateDureeFromAnnee);
      annee.addEventListener('change', updateDureeFromAnnee);
    }

    // Supprimer les z√©ros √† gauche pour tous les champs num√©riques (sauf duree qui est readonly)
    [capital, annee, tauxAnnuel].forEach(input => {
      if(input){
        input.addEventListener('blur', () => removeLeadingZeros(input));
        input.addEventListener('change', () => removeLeadingZeros(input));
      }
    });

    // Flags et s√©lecteurs pour g√©rer l'affichage annuel/mensuel et le deuxi√®me sc√©nario
    let isAnnual = false;
    let isAnnual2 = false;
    const annee2 = el('annee2');
    const capital2 = el('capital2');
    const duree2 = el('duree2');
    const tauxAnnuel2 = el('tauxAnnuel2');
    const tauxMensuel2 = el('tauxMensuel2');
    const warnDuree2 = el('warnDuree2');
    const kpiMensualite2 = el('kpiMensualite2');
    const kpiInterets2 = el('kpiInterets2');
    const tableBody2 = document.querySelector('#table2 tbody');

    function roundPrec(v){ const p = Math.pow(10, PREC); return Math.round((v + Number.EPSILON) * p) / p; }
    function pmt(rate_m, n, pv){ if (Math.abs(rate_m) < 1e-12) return pv / n; return pv * rate_m / (1 - Math.pow(1 + rate_m, -n)); }
    function mensualite(cap, tm_pct, n){ const r = tm_pct / 100; if (!isFinite(cap) || !isFinite(r) || !isFinite(n) || n <= 0) return NaN; return roundPrec(pmt(r, n, cap)); }
    function updateDerivedRates(){ const ta = parseFloat(tauxAnnuel.value || '0'); const tm = ta / 12; tauxMensuel.value = isFinite(tm) ? fmtNum(tm, 6) : ''; }
    function validateDuree(){ const n = parseInt(duree.value || '0', 10); const ok = n >= 1 && n <= 300; warnDuree.style.display = ok ? 'none' : 'block'; return ok; }

    function compute(){
      updateDerivedRates();
      if (!validateDuree()) { return; }
      const C = parseFloat(capital.value || '0');
      const n = parseInt(duree.value || '0', 10);
      const tm = parseFloat(tauxMensuel.value || '0'); // en %
      const M = mensualite(C, tm, n);

      let reste = C, totalInterets = 0;
      const r = tm / 100;
      for (let mois = 1; mois <= n; mois++) {
        const interet = roundPrec(reste * r);
        let principal = roundPrec(M - interet);
        if (mois === n) principal = roundPrec(reste);
        reste = roundPrec(reste - principal);
        totalInterets = roundPrec(totalInterets + interet);
      }
      kpiMensualite.textContent = isFinite(M) ? fmtMoney(M) : '‚Äî';
      kpiInterets.textContent = isFinite(totalInterets) ? fmtMoney(totalInterets) : '‚Äî';
    }


    // ---- G√©n√®re un tableau avec changement de taux apr√®s 3 ann√©es r√©volues (d√©but ann√©e 4 = mois 37) ----
    function generateScheduleWithRateChange(startYear = 3, newAnnualRate = null){
      // On force l'affichage mensuel
      if (typeof isAnnual !== 'undefined') isAnnual = false;
      // Nettoyage
      if (!tableBody) return;
      tableBody.innerHTML = '';
      
      // Afficher les en-t√™tes et le total
      const table = document.getElementById('table');
      if(table) table.classList.add('show-headers');

      // Lire les entr√©es actuelles
      const C0 = parseFloat(capital && capital.value || '0');
      const n  = parseInt(duree && duree.value || '0', 10);
      const ta = parseFloat(tauxAnnuel && tauxAnnuel.value || '0');
      const tm_pct = parseFloat(tauxMensuel && tauxMensuel.value || '0'); // en %

      if (!(C0 > 0) || !(n > 0)) return;
      const changeMonth = Math.max(1, (startYear - 1) * 12 + 1); // d√©but de la 3√®me ann√©e = mois 25
      const monthsBefore = Math.min(n, changeMonth - 1);         // 1..24 si n >= 24
      const monthsAfter  = Math.max(0, n - monthsBefore);

      // Taux et mensualit√© avant changement
      const r1 = tm_pct / 100;
      const M1 = mensualite(C0, tm_pct, n);
      if (!isFinite(M1)) return;

      // Boucle avant changement
      let reste = C0;
      let totalInterets = 0;
      const dateDebutEl = document.getElementById('dateDebut');
      const dateDebut = (dateDebutEl && dateDebutEl.value) ? new Date(dateDebutEl.value) : null;

      for (let mois = 1; mois <= monthsBefore; mois++){
        const interet = roundPrec(reste * r1);
        let principal = roundPrec(M1 - interet);
        let payment = M1;
        if (mois === n) { principal = roundPrec(reste); payment = roundPrec(interet + principal); }
        reste = roundPrec(reste - principal);

        const tr = document.createElement('tr');
        let periode = mois;
        if (dateDebut) {
          const d = new Date(dateDebut.getFullYear(), dateDebut.getMonth() + mois - 1, dateDebut.getDate());
          periode = d.toLocaleDateString('fr-FR', { year: 'numeric', month: '2-digit' });
        }
        [periode, fmtMoney(payment), fmtMoney(interet), fmtMoney(principal), fmtMoney(reste)]
          .forEach(v => { const td = document.createElement('td'); td.textContent = v; tr.appendChild(td); });
        tableBody.appendChild(tr);
        totalInterets = roundPrec(totalInterets + interet);
      }

      // Si le cr√©dit se termine avant le changement
      if (monthsAfter <= 0){
        if (kpiMensualite) kpiMensualite.textContent = isFinite(M1) ? fmtMoney(M1) : '‚Äî';
        if (kpiInterets)   kpiInterets.textContent   = isFinite(totalInterets) ? fmtMoney(totalInterets) : '‚Äî';
        const chartContainer = document.getElementById('chartContainer');
        if (chartContainer && chartContainer.style.display !== 'none'){ updateChart(); }
        return;
      }

      // Taux et mensualit√© apr√®s changement
      const ta2 = (newAnnualRate != null ? newAnnualRate : (ta / 2));
      const tm2_pct = ta2 / 12; // en %
      const r2 = tm2_pct / 100;
      const M2 = mensualite(reste, tm2_pct, monthsAfter);
      if (!isFinite(M2)) return;

      for (let k = 1; k <= monthsAfter; k++){
        const mois = monthsBefore + k;
        const interet = roundPrec(reste * r2);
        let principal = roundPrec(M2 - interet);
        let payment = M2;
        if (mois === n) { principal = roundPrec(reste); payment = roundPrec(interet + principal); }
        reste = roundPrec(reste - principal);

        const tr = document.createElement('tr');
        let periode = mois;
        if (dateDebut) {
          const d = new Date(dateDebut.getFullYear(), dateDebut.getMonth() + mois - 1, dateDebut.getDate());
          periode = d.toLocaleDateString('fr-FR', { year: 'numeric', month: '2-digit' });
        }
        [periode, fmtMoney(payment), fmtMoney(interet), fmtMoney(principal), fmtMoney(reste)]
          .forEach(v => { const td = document.createElement('td'); td.textContent = v; tr.appendChild(td); });
        tableBody.appendChild(tr);
        totalInterets = roundPrec(totalInterets + interet);
      }

      // KPIs : afficher M1 ‚Üí M2 et int√©r√™ts totaux
      if (kpiMensualite) kpiMensualite.textContent = fmtMoney(M1) + " ‚Üí " + fmtMoney(M2);
      if (kpiInterets)   kpiInterets.textContent   = isFinite(totalInterets) ? fmtMoney(totalInterets) : '‚Äî';

      const chartContainer = document.getElementById('chartContainer');
      if (chartContainer && chartContainer.style.display !== 'none'){ updateChart(); }
    }
function generateSchedule(){
      if (isAnnual){
        generateAnnualSchedule();
        return;
      }
      compute();
      if (!tableBody) return;
      tableBody.innerHTML = '';
      
      // Afficher les en-t√™tes et le total
      const table = document.getElementById('table');
      if(table) table.classList.add('show-headers');
      const C0 = parseFloat(capital && capital.value || '0');
      let reste = C0;
      const n = parseInt(duree && duree.value || '0', 10);
      const tm_pct = parseFloat(tauxMensuel && tauxMensuel.value || '0');
      const r = tm_pct / 100;
      const M = mensualite(C0, tm_pct, n);
      if (!isFinite(M)) { return; }
      
      // Variables pour les totaux
      let totalPay = 0, totalInt = 0, totalPrin = 0;
      
      const dateDebut = document.getElementById('dateDebut').value ? new Date(document.getElementById('dateDebut').value) : null;
      for (let mois = 1; mois <= n; mois++){
        const interet = roundPrec(reste * r);
        let principal = roundPrec(M - interet);
        let payment = M;
        if (mois === n) { principal = roundPrec(reste); payment = roundPrec(interet + principal); }
        reste = roundPrec(reste - principal);
        
        // Accumuler les totaux
        totalPay = roundPrec(totalPay + payment);
        totalInt = roundPrec(totalInt + interet);
        totalPrin = roundPrec(totalPrin + principal);
        
        const tr = document.createElement('tr');
        let periode = mois;
        if (dateDebut) {
          const date = new Date(dateDebut.getFullYear(), dateDebut.getMonth() + mois - 1, dateDebut.getDate());
          periode = date.toLocaleDateString('fr-FR', { year: 'numeric', month: '2-digit' });
        }
        [periode, fmtMoney(payment), fmtMoney(interet), fmtMoney(principal), fmtMoney(reste)]
          .forEach(v => { const td = document.createElement('td'); td.textContent = v; tr.appendChild(td); });
        tableBody.appendChild(tr);
      }
      
      // Mettre √† jour les totaux dans le tfoot
      const totalMensualiteEl = document.getElementById('totalMensualite');
      const totalInteretsEl = document.getElementById('totalInterets');
      const totalPrincipalEl = document.getElementById('totalPrincipal');
      if(totalMensualiteEl) totalMensualiteEl.textContent = fmtMoney(totalPay);
      if(totalInteretsEl) totalInteretsEl.textContent = fmtMoney(totalInt);
      if(totalPrincipalEl) totalPrincipalEl.textContent = fmtMoney(totalPrin);
      
      const chartContainer = document.getElementById('chartContainer');
      if (chartContainer && chartContainer.style.display !== 'none'){
        updateChart();
      }
    }

    /**
     * G√©n√®re un tableau d'amortissement annuel pour le sc√©nario 1 en agr√©geant les mensualit√©s,
     * les int√©r√™ts et le principal sur chaque p√©riode de 12 mois. Utilis√© lorsque l'utilisateur
     * s√©lectionne l'affichage annuel via le bouton d√©di√©.
     */
     function generateAnnualSchedule(){
       compute();
       tableBody.innerHTML = '';
       
       // Afficher les en-t√™tes et le total
       const table = document.getElementById('table');
       if(table) table.classList.add('show-headers');
      const C0 = parseFloat(capital.value || '0');
      let reste = C0;
      const n = parseInt(duree.value || '0', 10);
      const tm_pct = parseFloat(tauxMensuel.value || '0');
      const r = tm_pct / 100;
      const M = mensualite(C0, tm_pct, n);
      if (!isFinite(M)) { return; }
      let accPayment = 0, accInterest = 0, accPrincipal = 0;
      let year = 1;
      const dateDebut = document.getElementById('dateDebut').value ? new Date(document.getElementById('dateDebut').value) : null;
      for (let mois = 1; mois <= n; mois++){
        const interet = roundPrec(reste * r);
        let principal = roundPrec(M - interet);
        let payment = M;
        if (mois === n) { principal = roundPrec(reste); payment = roundPrec(interet + principal); }
        reste = roundPrec(reste - principal);
        accPayment = roundPrec(accPayment + payment);
        accInterest = roundPrec(accInterest + interet);
        accPrincipal = roundPrec(accPrincipal + principal);
        if (mois % 12 === 0 || mois === n){
          const tr = document.createElement('tr');
          let periode = year;
          if (dateDebut) {
            const date = new Date(dateDebut.getFullYear() + year - 1, dateDebut.getMonth(), dateDebut.getDate());
            periode = date.toLocaleDateString('fr-FR', { year: 'numeric' });
          }
          [periode, fmtMoney(accPayment), fmtMoney(accInterest), fmtMoney(accPrincipal), fmtMoney(reste)]
            .forEach(v => { const td = document.createElement('td'); td.textContent = v; tr.appendChild(td); });
          tableBody.appendChild(tr);
          accPayment = 0; accInterest = 0; accPrincipal = 0;
          year++;
        }
      }
      const chartContainer = document.getElementById('chartContainer');
      if (chartContainer && chartContainer.style.display !== 'none'){
        updateChart();
      }
    }

    function exportCSV(){
      const rows = [['Mois','Mensualit√©','Int√©r√™ts','Principal','Capital restant d√ª']];
      const trs = [...tableBody.querySelectorAll('tr')];
      if (!trs.length){ return; }
      trs.forEach(tr => { const cells = [...tr.querySelectorAll('td')].map(td => td.textContent.replace(/\s/g,'')); rows.push(cells); });
      const csv = rows.map(r => r.join(';')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'amortissement_scroll_compact.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    function resetAll(){ capital.value = 0; duree.value = 1; tauxAnnuel.value = 0; tableBody.innerHTML = ''; compute(); }
    function clearTable(){ tableBody.innerHTML = ''; }

    // ---- Graphiques ----
    // Maintient une instance unique du graphique d'amortissement
    let amortChart = null;

    /**
     * Met √† jour ou cr√©e le graphique d'amortissement √† partir des donn√©es du tableau.
     * Utilise Chart.js pour tracer les int√©r√™ts et le capital restant d√ª en fonction des mois.
     */
    function updateChart(){
      const aoa = getAmortizationAoA();
      const chartContainer = document.getElementById('chartContainer');
      if (!aoa || !chartContainer){ return; }
      // Pr√©pare les √©tiquettes et les s√©ries (int√©r√™ts et capital restant d√ª)
      const labels = [];
      const interestData = [];
      const principalData = [];
      for (let i = 1; i < aoa.length; i++){
        labels.push(aoa[i][0]);
        interestData.push(aoa[i][2]);
        principalData.push(aoa[i][3]); // Utiliser la colonne Principal (index 3)
      }
      const data = {
        labels: labels,
        datasets: [
          { label:'Int√©r√™ts', data: interestData, tension:0.3, borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)' },
          { label:'Principal', data: principalData, tension:0.3, borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.5)' }
        ]
      };
  // Couleurs dynamiques en fonction du th√®me : texte clair sur fond sombre, texte sombre sur fond clair
  const isDark = document.body.classList.contains('dark');
  // Essayez d'utiliser les variables CSS si disponibles, sinon valeurs fallback
  let textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
  if (!textColor) textColor = isDark ? '#f8fafc' : '#0f172a';
  const gridColor = isDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)';

  if (amortChart){
    // Met √† jour les donn√©es existantes
    amortChart.data = data;
    // Met √† jour les couleurs des axes et de la l√©gende pour correspondre au th√®me
    if (amortChart.options && amortChart.options.plugins && amortChart.options.plugins.legend && amortChart.options.plugins.legend.labels){
      amortChart.options.plugins.legend.labels.color = textColor;
    }
    if (amortChart.options && amortChart.options.scales){
      ['x','y'].forEach(axis => {
        if (amortChart.options.scales[axis]){
          if (!amortChart.options.scales[axis].ticks) amortChart.options.scales[axis].ticks = {};
          if (!amortChart.options.scales[axis].grid) amortChart.options.scales[axis].grid = {};
          amortChart.options.scales[axis].ticks.color = textColor;
          amortChart.options.scales[axis].grid.color = gridColor;
        }
      });
    }
    amortChart.update();
  } else {
    const ctx = document.getElementById('amortChart').getContext('2d');
    amortChart = new Chart(ctx, {
      type:'line',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: textColor } }
        },
        scales: {
          x: {
            ticks: { color: textColor },
            grid: { color: gridColor }
          },
          y: {
            ticks: { color: textColor },
            grid: { color: gridColor }
          }
        }
      }
    });
  }
    }
    
    // ======== Fonctions d√©di√©es au second sc√©nario (Sc√©nario¬†2) ========

    /**
     * Fonction pour convertir les ann√©es en mois pour le sc√©nario 2 (le champ mois reste toujours readonly)
     */
    function updateDureeFromAnnee2(){
      if(!annee2 || !duree2) return;
      const anneeVal = parseFloat(annee2.value || '0');
      if(anneeVal > 0){
        const mois = Math.round(anneeVal * 12);
        if(mois >= 1 && mois <= 300){
          duree2.value = mois;
        } else {
          annee2.value = '';
          duree2.value = 1;
          alert('La dur√©e en mois doit rester entre 1 et 300 mois (0.08 √† 25 ann√©es)');
        }
      } else {
        // Si le champ ann√©e est vide, r√©initialiser √† 1 mois
        duree2.value = 1;
      }
    }

    /**
     * Met √† jour la valeur du taux mensuel du second sc√©nario en fonction du taux annuel.
     */
    function updateDerivedRates2(){
      if (!tauxAnnuel2 || !tauxMensuel2) return;
      const ta2 = parseFloat(tauxAnnuel2.value || '0');
      const tm2 = ta2 / 12;
      tauxMensuel2.value = isFinite(tm2) ? fmtNum(tm2, 6) : '';
    }

    /**
     * Valide la dur√©e du second sc√©nario (entre 1 et 300 mois). Affiche un avertissement si invalide.
     */
    function validateDuree2(){
      if (!duree2 || !warnDuree2) return false;
      const n2 = parseInt(duree2.value || '0', 10);
      const ok2 = n2 >= 1 && n2 <= 300;
      warnDuree2.style.display = ok2 ? 'none' : 'block';
      return ok2;
    }

    /**
     * Calcule la mensualit√© et le co√ªt total des int√©r√™ts pour le second sc√©nario et met √† jour les KPI.
     */
    function compute2(){
      updateDerivedRates2();
      if (!validateDuree2()) { return; }
      const C2 = parseFloat(capital2 && capital2.value || '0');
      const n2 = parseInt(duree2 && duree2.value || '0', 10);
      const tm2 = parseFloat(tauxMensuel2 && tauxMensuel2.value || '0');
      const M2 = mensualite(C2, tm2, n2);
      let reste2 = C2, totalInterets2 = 0;
      const r2 = tm2 / 100;
      for (let mois = 1; mois <= n2; mois++){
        const interet2 = roundPrec(reste2 * r2);
        let principal2 = roundPrec(M2 - interet2);
        if (mois === n2) principal2 = roundPrec(reste2);
        reste2 = roundPrec(reste2 - principal2);
        totalInterets2 = roundPrec(totalInterets2 + interet2);
      }
      if (kpiMensualite2) kpiMensualite2.textContent = isFinite(M2) ? fmtMoney(M2) : '‚Äî';
      if (kpiInterets2) kpiInterets2.textContent = isFinite(totalInterets2) ? fmtMoney(totalInterets2) : '‚Äî';
    }

    /**
     * G√©n√®re le tableau mensuel pour le second sc√©nario.
     */
     function generateSchedule2(){
       if (isAnnual2){
         generateAnnualSchedule2();
         return;
       }
       compute2();
       if (!tableBody2) return;
       tableBody2.innerHTML = '';
       
       // Afficher les en-t√™tes et le total
       const table2 = document.getElementById('table2');
       if(table2) table2.classList.add('show-headers');
       const C0 = parseFloat(capital2 && capital2.value || '0');
       let reste = C0;
       const n = parseInt(duree2 && duree2.value || '0', 10);
       const tm_pct = parseFloat(tauxMensuel2 && tauxMensuel2.value || '0');
       const r = tm_pct / 100;
       const M = mensualite(C0, tm_pct, n);
       if (!isFinite(M)) { return; }
       
       // Variables pour les totaux
       let totalPay = 0, totalInt = 0, totalPrin = 0;
       
       const dateDebut = document.getElementById('dateDebut').value ? new Date(document.getElementById('dateDebut').value) : null;
       for (let mois = 1; mois <= n; mois++){
         const interet = roundPrec(reste * r);
         let principal = roundPrec(M - interet);
         let payment = M;
         if (mois === n) { principal = roundPrec(reste); payment = roundPrec(interet + principal); }
         reste = roundPrec(reste - principal);
         
         // Accumuler les totaux
         totalPay = roundPrec(totalPay + payment);
         totalInt = roundPrec(totalInt + interet);
         totalPrin = roundPrec(totalPrin + principal);
         
         const tr = document.createElement('tr');
         let periode = mois;
         if (dateDebut) {
           const date = new Date(dateDebut.getFullYear(), dateDebut.getMonth() + mois - 1, dateDebut.getDate());
           periode = date.toLocaleDateString('fr-FR', { year: 'numeric', month: '2-digit' });
         }
         [periode, fmtMoney(payment), fmtMoney(interet), fmtMoney(principal), fmtMoney(reste)]
           .forEach(v => { const td = document.createElement('td'); td.textContent = v; tr.appendChild(td); });
         tableBody.appendChild(tr);
       }
       
       // Mettre √† jour les totaux dans le tfoot
       const totalMensualiteEl = document.getElementById('totalMensualite2');
       const totalInteretsEl = document.getElementById('totalInterets2');
       const totalPrincipalEl = document.getElementById('totalPrincipal2');
       if(totalMensualiteEl) totalMensualiteEl.textContent = fmtMoney(totalPay);
       if(totalInteretsEl) totalInteretsEl.textContent = fmtMoney(totalInt);
       if(totalPrincipalEl) totalPrincipalEl.textContent = fmtMoney(totalPrin);
       
       const chartContainer2 = document.getElementById('chartContainer2');
       if (chartContainer2 && chartContainer2.style.display !== 'none'){
         updateChart2();
       }
     }

    /**
     * G√©n√®re le tableau annuel pour le second sc√©nario.
     */
     function generateAnnualSchedule2(){
       compute2();
       if (!tableBody2) return;
       tableBody2.innerHTML = '';
       
       // Afficher les en-t√™tes et le total
       const table2 = document.getElementById('table2');
       if(table2) table2.classList.add('show-headers');
      const C0 = parseFloat(capital2 && capital2.value || '0');
      let reste = C0;
      const n = parseInt(duree2 && duree2.value || '0', 10);
      const tm_pct = parseFloat(tauxMensuel2 && tauxMensuel2.value || '0');
      const r = tm_pct / 100;
      const M = mensualite(C0, tm_pct, n);
      if (!isFinite(M)) { return; }
      let accPayment = 0, accInterest = 0, accPrincipal = 0;
      let year = 1;
      const dateDebut2 = document.getElementById('dateDebut2').value ? new Date(document.getElementById('dateDebut2').value) : null;
      for (let mois = 1; mois <= n; mois++){
        const interet = roundPrec(reste * r);
        let principal = roundPrec(M - interet);
        let payment = M;
        if (mois === n) { principal = roundPrec(reste); payment = roundPrec(interet + principal); }
        reste = roundPrec(reste - principal);
        accPayment = roundPrec(accPayment + payment);
        accInterest = roundPrec(accInterest + interet);
        accPrincipal = roundPrec(accPrincipal + principal);
        if (mois % 12 === 0 || mois === n){
          const tr = document.createElement('tr');
          let periode = year;
          if (dateDebut2) {
            const date = new Date(dateDebut2.getFullYear() + year - 1, dateDebut2.getMonth(), dateDebut2.getDate());
            periode = date.toLocaleDateString('fr-FR', { year: 'numeric' });
          }
          [periode, fmtMoney(accPayment), fmtMoney(accInterest), fmtMoney(accPrincipal), fmtMoney(reste)]
            .forEach(v => { const td = document.createElement('td'); td.textContent = v; tr.appendChild(td); });
          tableBody2.appendChild(tr);
          accPayment = 0; accInterest = 0; accPrincipal = 0;
          year++;
        }
      }
      const chartContainer2 = document.getElementById('chartContainer2');
      if (chartContainer2 && chartContainer2.style.display !== 'none'){
        updateChart2();
      }
    }

    /**
     * Convertit le tableau d'amortissement du sc√©nario¬†2 en array-of-arrays pour l'exportation.
     */
    function getAmortizationAoA2(){
      const tbody2 = document.querySelector('#table2 tbody');
      const trs2 = tbody2 ? [...tbody2.querySelectorAll('tr')] : [];
      if (!trs2.length) return null;
      const header2 = [
        isAnnual2 ? 'Ann√©e' : 'P√©riode',
        isAnnual2 ? 'Annuit√©' : 'Mensualit√©',
        'Int√©r√™ts',
        'Principal',
        'Capital restant d√ª'
      ];
      const rows2 = trs2.map(tr => {
        const tds = [...tr.querySelectorAll('td')].map(td => td.textContent.trim());
        return [
          tds[0], // Laisser comme string (P√©riode/Ann√©e/Date)
          frMoneyToNumber(tds[1]),
          frMoneyToNumber(tds[2]),
          frMoneyToNumber(tds[3]),
          frMoneyToNumber(tds[4]),
        ];
      });
      return [header2, ...rows2];
    }

    /**
     * Graphique pour le second sc√©nario. Utilise Chart.js pour tracer l'√©volution des int√©r√™ts et du capital restant d√ª.
     */
    let amortChart2 = null;
    function updateChart2(){
      const aoa2 = getAmortizationAoA2();
      const chartContainer2 = document.getElementById('chartContainer2');
      if (!aoa2 || !chartContainer2){ return; }
      const labels2 = [];
      const interestData2 = [];
      const principalData2 = [];
      for (let i = 1; i < aoa2.length; i++){
        labels2.push(aoa2[i][0]);
        interestData2.push(aoa2[i][2]);
        principalData2.push(aoa2[i][3]); // Utiliser la colonne Principal (index 3)
      }
      const data2 = {
        labels: labels2,
        datasets: [
          { label:'Int√©r√™ts', data: interestData2, tension:0.3, borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.5)' },
          { label:'Principal', data: principalData2, tension:0.3, borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54, 162, 235, 0.5)' }
        ]
      };
      const isDark2 = document.body.classList.contains('dark');
      let textColor2 = getComputedStyle(document.body).getPropertyValue('--text').trim();
      if (!textColor2) textColor2 = isDark2 ? '#f8fafc' : '#0f172a';
      const gridColor2 = isDark2 ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)';
      if (amortChart2){
        amortChart2.data = data2;
        if (amortChart2.options && amortChart2.options.plugins && amortChart2.options.plugins.legend && amortChart2.options.plugins.legend.labels){
          amortChart2.options.plugins.legend.labels.color = textColor2;
        }
        if (amortChart2.options && amortChart2.options.scales){
          ['x','y'].forEach(axis => {
            if (amortChart2.options.scales[axis]){
              if (!amortChart2.options.scales[axis].ticks) amortChart2.options.scales[axis].ticks = {};
              if (!amortChart2.options.scales[axis].grid) amortChart2.options.scales[axis].grid = {};
              amortChart2.options.scales[axis].ticks.color = textColor2;
              amortChart2.options.scales[axis].grid.color = gridColor2;
            }
          });
        }
        amortChart2.update();
      } else {
        const ctx2 = document.getElementById('amortChart2').getContext('2d');
        amortChart2 = new Chart(ctx2, {
          type:'line',
          data: data2,
          options: {
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ legend:{ labels:{ color:textColor2 } } },
            scales:{
              x:{ ticks:{ color:textColor2 }, grid:{ color:gridColor2 } },
              y:{ ticks:{ color:textColor2 }, grid:{ color:gridColor2 } }
            }
          }
        });
      }
    }

    /**
     * Exporte le tableau du sc√©nario¬†2 au format XLSX √† l'aide de SheetJS.
     */
    function exportXLSX2(){
      const aoa2 = getAmortizationAoA2();
      if (!aoa2){ alert("G√©n√®re d'abord le tableau d'amortissement."); return; }
      if (typeof XLSX === 'undefined'){ alert("Biblioth√®que XLSX non charg√©e."); return; }
      const wb2 = XLSX.utils.book_new();
      const ws2 = XLSX.utils.aoa_to_sheet(aoa2);
      const range2 = XLSX.utils.decode_range(ws2['!ref']);
      for (let R = 1; R <= range2.e.r; R++){
        for (let C = 1; C <= 4; C++){
          const cellAddr2 = XLSX.utils.encode_cell({r:R, c:C});
          const cell2 = ws2[cellAddr2];
          if (cell2 && typeof cell2.v === 'number'){
            cell2.t = 'n';
            cell2.z = '0.000';
          }
        }
      }
      ws2['!cols'] = [{wch:6},{wch:14},{wch:12},{wch:12},{wch:18}];
      XLSX.utils.book_append_sheet(wb2, ws2, 'Amortissement');
      XLSX.writeFile(wb2, 'amortissement2.xlsx', {bookType:'xlsx'});
    }

    /**
     * R√©initialise les valeurs du second sc√©nario aux valeurs par d√©faut.
     */
    function resetAll2(){
      if (capital2) capital2.value = '0';
      if (duree2) duree2.value = '1';
      if (tauxAnnuel2) tauxAnnuel2.value = '0';
      if (tauxMensuel2) tauxMensuel2.value = fmtNum(0, 6);
      if (kpiMensualite2) kpiMensualite2.textContent = '‚Äî';
      if (kpiInterets2) kpiInterets2.textContent = '‚Äî';
      if (warnDuree2) warnDuree2.style.display = 'none';
      if (tableBody2) tableBody2.innerHTML = '';
    }

    
    // ---- R√©duction de taux si dur√©e > 84 mois et (Int√©r√™ts 36 mois / CRD √† 36 mois) >= 8% ----
    function simulateMetrics(C, n, tm_pct){
      const r = tm_pct / 100;
      const M = mensualite(C, tm_pct, n);
      if (!isFinite(M)) return { interets36mois: NaN, reste36: NaN };
      let reste = C;
      let interets36mois = 0;
      let reste36 = NaN;
      for (let mois = 1; mois <= n; mois++) {
        const interet = roundPrec(reste * r);
        let principal = roundPrec(M - interet);
        if (mois === n) principal = roundPrec(reste);
        reste = roundPrec(reste - principal);
        // Accumuler les int√©r√™ts uniquement pour les 36 premiers mois
        if (mois <= 36) {
          interets36mois = roundPrec(interets36mois + interet);
        }
        if (mois === 36) reste36 = reste;
      }
      if (!isFinite(reste36)) reste36 = reste;
      return { interets36mois, reste36 };
    }

    function reduceRateIfEligible(){
      const C = parseFloat(document.getElementById('capital').value || '0');
      const n = parseInt(document.getElementById('duree').value || '0', 10);
      const ta = parseFloat(document.getElementById('tauxAnnuel').value || '0');
      const tm_pct = parseFloat(document.getElementById('tauxMensuel').value || '0');

      if (!(C > 0) || !(n > 0) || !(ta >= 0)) { alert("Veuillez saisir un cr√©dit valide d'abord."); return; }

      const condDuree = n > 84; // > 7 ans
      const { interets36mois, reste36 } = simulateMetrics(C, n, tm_pct);
      if (!isFinite(interets36mois) || !isFinite(reste36) || reste36 <= 0){
        alert("Donn√©es insuffisantes pour √©valuer l'√©ligibilit√©.");
        return;
      }
      const ratio = interets36mois / reste36;
      const condRatio = ratio >= 0.08;

      if (condDuree && condRatio){
        const oldTA = ta;
        const newTA = oldTA / 2;

        if (typeof generateScheduleWithRateChange === 'function') generateScheduleWithRateChange(4, newTA);

        alert(
          "‚úÖ √âligible : taux r√©duit de moiti√©.\n"
          + "Ancien taux annuel : " + oldTA + "%\n"
          + "Nouveau taux annuel : " + newTA + "%\n"
          + "Ratio (Int√©r√™ts 36 mois / CRD √† 36 mois) : " + (ratio*100).toFixed(2) + "%"
        );
      } else {
        let msg = "‚ùå Non √©ligible √† la r√©duction :\n";
        msg += "- Dur√©e > 84 mois ? " + (condDuree ? "Oui" : "Non") + "\n";
        msg += "- Ratio ‚â• 8% ? " + (ratio*100).toFixed(2) + "% " + (condRatio ? "‚â• 8%" : "< 8%") + "\n";
        alert(msg);
      }
    }
// Wire
    document.getElementById('btnCalcul').addEventListener('click', compute);
    document.getElementById('btnGen').addEventListener('click', generateSchedule);
    /* Suppression du gestionnaire d'export CSV */
    document.getElementById('btnReset').addEventListener('click', resetAll);
    document.getElementById('btnReducTaux').addEventListener('click', reduceRateIfEligible);
    // btnClear supprim√© et remplac√© par btnComparer

    // Gestion de l'affichage annuel/mensuel pour le sc√©nario¬†1
    const btnTogglePeriod = document.getElementById('btnTogglePeriod');
    if (btnTogglePeriod){
      btnTogglePeriod.addEventListener('click', function(){
        isAnnual = !isAnnual;
        const headerCells = document.querySelectorAll('#table thead th');
        if (headerCells && headerCells[0]) headerCells[0].textContent = isAnnual ? 'Ann√©e' : 'P√©riode';
        if (headerCells && headerCells[1]) headerCells[1].textContent = isAnnual ? 'Annuit√©' : 'Mensualit√©';
        btnTogglePeriod.textContent = isAnnual ? 'Affichage: Mensuel' : 'Affichage: Annuel';
        generateSchedule();
      });
    }

    // Bouton pour afficher/masquer le deuxi√®me sc√©nario
    const btnAddScenario = document.getElementById('btnAddScenario');
    if (btnAddScenario){
      btnAddScenario.addEventListener('click', function(){
        const sc2 = document.getElementById('scenario2');
        if (!sc2) return;
        if (sc2.style.display === 'none' || sc2.style.display === ''){
          sc2.style.display = '';
          btnAddScenario.textContent = 'Masquer le sc√©nario';
        } else {
          sc2.style.display = 'none';
          btnAddScenario.textContent = 'Ajouter un sc√©nario';
        }
      });
    }

    // Attache les gestionnaires pour le sc√©nario¬†2
    const btnCalcul2El = document.getElementById('btnCalcul2');
    if (btnCalcul2El) btnCalcul2El.addEventListener('click', compute2);
    const btnGen2El = document.getElementById('btnGen2');
    if (btnGen2El) btnGen2El.addEventListener('click', generateSchedule2);
    const btnReset2El = document.getElementById('btnReset2');
    if (btnReset2El) btnReset2El.addEventListener('click', function(e){ e.preventDefault(); resetAll2(); });
    const btnClear2El = document.getElementById('btnClear2');
    if (btnClear2El) btnClear2El.addEventListener('click', function(){ if (tableBody2) tableBody2.innerHTML = ''; });
    const btnToggleChart2El = document.getElementById('btnToggleChart2');
    if (btnToggleChart2El){
      btnToggleChart2El.addEventListener('click', function(){
        const cc2 = document.getElementById('chartContainer2');
        if (!cc2) return;
        if (cc2.style.display === 'none' || cc2.style.display === ''){
          cc2.style.display = '';
          btnToggleChart2El.textContent = 'Masquer Graphique';
          updateChart2();
        } else {
          cc2.style.display = 'none';
          btnToggleChart2El.textContent = 'Graphique';
        }
      });
    }
    const btnTogglePeriod2El = document.getElementById('btnTogglePeriod2');
    if (btnTogglePeriod2El){
      btnTogglePeriod2El.addEventListener('click', function(){
        isAnnual2 = !isAnnual2;
        const headerCells2 = document.querySelectorAll('#table2 thead th');
        if (headerCells2 && headerCells2[0]) headerCells2[0].textContent = isAnnual2 ? 'Ann√©e' : 'P√©riode';
        if (headerCells2 && headerCells2[1]) headerCells2[1].textContent = isAnnual2 ? 'Annuit√©' : 'Mensualit√©';
        btnTogglePeriod2El.textContent = isAnnual2 ? 'Affichage: Mensuel' : 'Affichage: Annuel';
        generateSchedule2();
      });
    }
    const btnExportXLSX2El = document.getElementById('btnExportXLSX2');
    if (btnExportXLSX2El) btnExportXLSX2El.addEventListener('click', exportXLSX2);

    // Bouton pour afficher/masquer le graphique d'amortissement
    const btnToggleChart = document.getElementById('btnToggleChart');
    if (btnToggleChart){
      btnToggleChart.addEventListener('click', function(){
        const chartContainer = document.getElementById('chartContainer');
        if (!chartContainer){ return; }
        // Si le graphique est masqu√© (display:none), on l'affiche et on met √† jour les donn√©es
        if (chartContainer.style.display === 'none'){
          chartContainer.style.display = '';
          btnToggleChart.textContent = 'Masquer Graphique';
          updateChart();
        } else {
          chartContainer.style.display = 'none';
          btnToggleChart.textContent = 'Graphique';
        }
      });
    }

// Live updates
      ['input','change'].forEach(evt => { tauxAnnuel.addEventListener(evt, updateDerivedRates); duree.addEventListener(evt, validateDuree); });
      // Ajout de l'√©couteur pour la date de d√©but afin de r√©g√©n√©rer le tableau
      const dateDebut = document.getElementById('dateDebut');
      if(dateDebut) dateDebut.addEventListener('change', generateSchedule);
      
      // Attacher les √©v√©nements pour le sc√©nario 2
      if(annee2){
        annee2.addEventListener('input', updateDureeFromAnnee2);
        annee2.addEventListener('change', updateDureeFromAnnee2);
      }
      
      // Supprimer les z√©ros √† gauche pour le sc√©nario 2 (sauf duree2 qui est readonly)
      [capital2, annee2, tauxAnnuel2].forEach(input => {
        if(input){
          input.addEventListener('blur', () => removeLeadingZeros(input));
          input.addEventListener('change', () => removeLeadingZeros(input));
        }
      });
      
      ['input','change'].forEach(evt => { tauxAnnuel2.addEventListener(evt, updateDerivedRates2); duree2.addEventListener(evt, validateDuree2); });
      const dateDebut2 = document.getElementById('dateDebut2');
      if(dateDebut2) dateDebut2.addEventListener('change', generateSchedule2);
      
      // Init
      updateDerivedRates(); validateDuree(); compute();
  </script>

<script>
// ---- Utils : parse "1 234,567 TND" -> 1234.567 (Number)
function frMoneyToNumber(str){
  if (!str) return NaN;
  // retire TND et autres lettres
  let s = String(str).replace(/[^\d,\.\-\u202f\u00a0]/g,'');
  // retire espaces (classiques, ins√©cables, fines ins√©cables)
  s = s.replace(/[\s\u00a0\u202f]/g, '');
  // En FR: virgule = d√©cimale. Retire points des milliers, remplace virgule par point.
  s = s.replace(/\.(?=\d{3}(?:\D|$))/g,'').replace(',', '.');
  const num = Number(s);
  return isFinite(num) ? num : NaN;
}

function getAmortizationAoA(){
      const tbody = document.querySelector('#table tbody') || document.querySelector('table tbody');
      const trs = tbody ? [...tbody.querySelectorAll('tr')] : [];
      if (!trs.length) return null;
      const header = [
        isAnnual ? 'Ann√©e' : 'P√©riode',
        isAnnual ? 'Annuit√©' : 'Mensualit√©',
        'Int√©r√™ts',
        'Principal',
        'Capital restant d√ª'
      ];
      const rows = trs.map(tr => {
        const tds = [...tr.querySelectorAll('td')].map(td => td.textContent.trim());
        // La premi√®re colonne (P√©riode/Ann√©e) peut √™tre une date ou un nombre, on la laisse comme string pour l'export
        return [
          tds[0],
          frMoneyToNumber(tds[1]),
          frMoneyToNumber(tds[2]),
          frMoneyToNumber(tds[3]),
          frMoneyToNumber(tds[4]),
        ];
      });
      return [header, ...rows];
    }

function exportXLSX(){
  const aoa = getAmortizationAoA();
  if (!aoa){ alert("G√©n√®re d'abord le tableau d'amortissement."); return; }
  if (typeof XLSX === 'undefined'){ alert("Biblioth√®que XLSX non charg√©e."); return; }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(aoa);

  // Formats num√©riques √† 3 d√©cimales pour les montants
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let R = 1; R <= range.e.r; R++){
    for (let C = 1; C <= 4; C++){
      const cellAddr = XLSX.utils.encode_cell({r:R, c:C});
      const cell = ws[cellAddr];
      if (cell && typeof cell.v === 'number'){
        cell.t = 'n';
        cell.z = '0.000';
      }
    }
  }

  // Largeurs de colonnes
  ws['!cols'] = [{wch:6},{wch:14},{wch:12},{wch:12},{wch:18}];

  XLSX.utils.book_append_sheet(wb, ws, 'Amortissement');
  XLSX.writeFile(wb, 'amortissement.xlsx', {bookType:'xlsx'});
}

// Wire: attache le clic
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('btnExportXLSX');
  if (btn) btn.addEventListener('click', exportXLSX);
  
  const btnPDF = document.getElementById('btnExportPDF');
  if (btnPDF) btnPDF.addEventListener('click', exportPDF);
  
  const btnPDF2 = document.getElementById('btnExportPDF2');
  if (btnPDF2) btnPDF2.addEventListener('click', exportPDF2);
});

/**
 * Exporte les donn√©es saisies et le tableau d'amortissement du sc√©nario 1 en PDF
 */
function exportPDF(){
  const aoa = getAmortizationAoA();
  if (!aoa){ alert("G√©n√®re d'abord le tableau d'amortissement."); return; }
  
  // R√©cup√©ration des donn√©es saisies
  const capital = document.getElementById('capital').value;
  const duree = document.getElementById('duree').value;
  const tauxAnnuel = document.getElementById('tauxAnnuel').value;
  const tauxMensuel = document.getElementById('tauxMensuel').value;
  const dateDebut = document.getElementById('dateDebut').value;
  let mensualite = document.getElementById('kpiMensualite').textContent;
  let interets = document.getElementById('kpiInterets').textContent;
  
  // Nettoyer les montants pour le PDF (remplacer les espaces ins√©cables par des espaces normaux)
  mensualite = mensualite.replace(/[\u00a0\u202f]/g, ' ').replace(/\s+/g, ' ').trim();
  interets = interets.replace(/[\u00a0\u202f]/g, ' ').replace(/\s+/g, ' ').trim();
  
  // Cr√©ation du document PDF avec jsPDF
  if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined'){
    alert("Biblioth√®que jsPDF non charg√©e.");
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Titre
  doc.setFontSize(18);
  doc.setTextColor(14, 165, 233);
  doc.text('Simulateur de Credit - Scenario 1', 105, 15, { align: 'center' });
  
  // Informations saisies
  doc.setFontSize(12);
  doc.setTextColor(15, 23, 42);
  doc.text('Donnees du credit:', 14, 30);
  
  doc.setFontSize(10);
  let yPos = 40;
  doc.text('Capital emprunte: ' + capital + ' TND', 14, yPos);
  yPos += 7;
  doc.text('Duree: ' + duree + ' mois', 14, yPos);
  yPos += 7;
  doc.text('Taux d\'interet annuel: ' + tauxAnnuel + '%', 14, yPos);
  yPos += 7;
  doc.text('Taux d\'interet mensuel: ' + tauxMensuel + '%', 14, yPos);
  yPos += 7;
  if(dateDebut) {
    doc.text('Date de debut: ' + dateDebut, 14, yPos);
    yPos += 7;
  }
  
  // KPIs
  yPos += 5;
  doc.setFontSize(12);
  doc.setTextColor(14, 165, 233);
  doc.text('Resultats:', 14, yPos);
  yPos += 10;
  
  doc.setFontSize(10);
  doc.setTextColor(15, 23, 42);
  doc.text('Mensualite: ' + mensualite, 14, yPos);
  yPos += 7;
  doc.text('Cout total des interets: ' + interets, 14, yPos);
  yPos += 15;
  
  // Tableau d'amortissement
  doc.setFontSize(12);
  doc.setTextColor(14, 165, 233);
  doc.text('Tableau d\'amortissement:', 14, yPos);
  yPos += 10;
  
  // Utilisation de autoTable pour le tableau
  if (typeof doc.autoTable !== 'undefined'){
    doc.autoTable({
      head: [aoa[0]],
      body: aoa.slice(1),
      startY: yPos,
      theme: 'grid',
      headStyles: { fillColor: [14, 165, 233], textColor: [255, 255, 255] },
      styles: { fontSize: 8, cellPadding: 2 },
      columnStyles: {
        0: { cellWidth: 25 },
        1: { cellWidth: 35, halign: 'right' },
        2: { cellWidth: 35, halign: 'right' },
        3: { cellWidth: 35, halign: 'right' },
        4: { cellWidth: 40, halign: 'right' }
      }
    });
  } else {
    // Fallback si autoTable n'est pas disponible
    doc.setFontSize(8);
    doc.text(aoa[0].join('  |  '), 14, yPos);
    yPos += 5;
    for(let i = 1; i < Math.min(aoa.length, 30); i++){
      if(yPos > 280) break;
      doc.text(aoa[i].join('  |  '), 14, yPos);
      yPos += 5;
    }
  }
  
  // Sauvegarde
  doc.save('amortissement_scenario1.pdf');
}

/**
 * Exporte les donn√©es saisies et le tableau d'amortissement du sc√©nario 2 en PDF
 */
function exportPDF2(){
  const aoa2 = getAmortizationAoA2();
  if (!aoa2){ alert("G√©n√®re d'abord le tableau d'amortissement."); return; }
  
  // R√©cup√©ration des donn√©es saisies
  const capital2 = document.getElementById('capital2').value;
  const duree2 = document.getElementById('duree2').value;
  const tauxAnnuel2 = document.getElementById('tauxAnnuel2').value;
  const tauxMensuel2 = document.getElementById('tauxMensuel2').value;
  const dateDebut2 = document.getElementById('dateDebut2').value;
  let mensualite2 = document.getElementById('kpiMensualite2').textContent;
  let interets2 = document.getElementById('kpiInterets2').textContent;
  
  // Nettoyer les montants pour le PDF (remplacer les espaces ins√©cables par des espaces normaux)
  mensualite2 = mensualite2.replace(/[\u00a0\u202f]/g, ' ').replace(/\s+/g, ' ').trim();
  interets2 = interets2.replace(/[\u00a0\u202f]/g, ' ').replace(/\s+/g, ' ').trim();
  
  // Cr√©ation du document PDF avec jsPDF
  if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined'){
    alert("Biblioth√®que jsPDF non charg√©e.");
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Titre
  doc.setFontSize(18);
  doc.setTextColor(14, 165, 233);
  doc.text('Simulateur de Credit - Scenario 2', 105, 15, { align: 'center' });
  
  // Informations saisies
  doc.setFontSize(12);
  doc.setTextColor(15, 23, 42);
  doc.text('Donnees du credit:', 14, 30);
  
  doc.setFontSize(10);
  let yPos = 40;
  doc.text('Capital emprunte: ' + capital2 + ' TND', 14, yPos);
  yPos += 7;
  doc.text('Duree: ' + duree2 + ' mois', 14, yPos);
  yPos += 7;
  doc.text('Taux d\'interet annuel: ' + tauxAnnuel2 + '%', 14, yPos);
  yPos += 7;
  doc.text('Taux d\'interet mensuel: ' + tauxMensuel2 + '%', 14, yPos);
  yPos += 7;
  if(dateDebut2) {
    doc.text('Date de debut: ' + dateDebut2, 14, yPos);
    yPos += 7;
  }
  
  // KPIs
  yPos += 5;
  doc.setFontSize(12);
  doc.setTextColor(14, 165, 233);
  doc.text('Resultats:', 14, yPos);
  yPos += 10;
  
  doc.setFontSize(10);
  doc.setTextColor(15, 23, 42);
  doc.text('Mensualite: ' + mensualite2, 14, yPos);
  yPos += 7;
  doc.text('Cout total des interets: ' + interets2, 14, yPos);
  yPos += 15;
  
  // Tableau d'amortissement
  doc.setFontSize(12);
  doc.setTextColor(14, 165, 233);
  doc.text('Tableau d\'amortissement:', 14, yPos);
  yPos += 10;
  
  // Utilisation de autoTable pour le tableau
  if (typeof doc.autoTable !== 'undefined'){
    doc.autoTable({
      head: [aoa2[0]],
      body: aoa2.slice(1),
      startY: yPos,
      theme: 'grid',
      headStyles: { fillColor: [14, 165, 233], textColor: [255, 255, 255] },
      styles: { fontSize: 8, cellPadding: 2 },
      columnStyles: {
        0: { cellWidth: 25 },
        1: { cellWidth: 35, halign: 'right' },
        2: { cellWidth: 35, halign: 'right' },
        3: { cellWidth: 35, halign: 'right' },
        4: { cellWidth: 40, halign: 'right' }
      }
    });
  } else {
    // Fallback si autoTable n'est pas disponible
    doc.setFontSize(8);
    doc.text(aoa2[0].join('  |  '), 14, yPos);
    yPos += 5;
    for(let i = 1; i < Math.min(aoa2.length, 30); i++){
      if(yPos > 280) break;
      doc.text(aoa2[i].join('  |  '), 14, yPos);
      yPos += 5;
    }
  }
  
  // Sauvegarde
  doc.save('amortissement_scenario2.pdf');
}

/**
 * R√©cup√®re les donn√©es du tableau d'amortissement du sc√©nario 2
 */
function getAmortizationAoA2(){
  const tbody2 = document.querySelector('#table2 tbody');
  const trs2 = tbody2 ? [...tbody2.querySelectorAll('tr')] : [];
  if (!trs2.length) return null;
  const header2 = [
    isAnnual2 ? 'Ann√©e' : 'P√©riode',
    isAnnual2 ? 'Annuit√©' : 'Mensualit√©',
    'Int√©r√™ts',
    'Principal',
    'Capital restant d√ª'
  ];
  const rows2 = trs2.map(tr => {
    const tds = [...tr.querySelectorAll('td')].map(td => td.textContent.trim());
    return [
      tds[0],
      frMoneyToNumber(tds[1]),
      frMoneyToNumber(tds[2]),
      frMoneyToNumber(tds[3]),
      frMoneyToNumber(tds[4]),
    ];
  });
  return [header2, ...rows2];
}

/**
 * Fonction pour partager par email les r√©sultats du sc√©nario 1
 * G√©n√®re automatiquement le PDF et ouvre l'email avec un tableau r√©capitulatif
 */
function partagerParEmail(){
  const capital = document.getElementById('capital').value;
  const duree = document.getElementById('duree').value;
  const tauxAnnuel = document.getElementById('tauxAnnuel').value;
  const dateDebut = document.getElementById('dateDebut').value;
  const mensualite = document.getElementById('kpiMensualite').textContent;
  const interets = document.getElementById('kpiInterets').textContent;
  
  if (!capital || !duree || !tauxAnnuel || mensualite === '‚Äî') {
    alert('Veuillez d\'abord calculer votre cr√©dit avant de partager.');
    return;
  }
  
  // V√©rifier si le tableau d'amortissement existe
  const tbody = document.querySelector('#table tbody');
  if (!tbody || tbody.children.length === 0) {
    alert('‚ö†Ô∏è Veuillez d\'abord g√©n√©rer le tableau d\'amortissement avant de partager.');
    return;
  }
  
  // 1. G√©n√©rer et t√©l√©charger le PDF automatiquement
  try {
    exportPDF();
  } catch(e) {
    console.error('Erreur lors de la g√©n√©ration du PDF:', e);
  }
  
  // 2. Attendre un peu pour que le PDF soit t√©l√©charg√©
  setTimeout(function(){
    // 3. Construire le tableau r√©capitulatif HTML pour l'email
    const tableauHTML = `
=== SIMULATION DE CREDIT ===

DONNEES DE BASE:
-----------------
Capital emprunte : ${capital} TND
Duree : ${duree} mois
Taux d'interet annuel : ${tauxAnnuel}%
Date de debut : ${dateDebut || 'Non specifiee'}

RESULTATS:
-----------------
Mensualite : ${mensualite}
Cout total des interets : ${interets}

TABLEAU D'AMORTISSEMENT:
-----------------
(Voir le fichier PDF joint pour le d√©tail complet)

INSTRUCTIONS:
-----------------
1. Un fichier PDF "amortissement_scenario1.pdf" a √©t√© t√©l√©charg√© dans votre dossier T√©l√©chargements
2. Veuillez joindre ce fichier PDF √† cet email avant de l'envoyer
3. Le PDF contient le tableau d'amortissement complet avec tous les d√©tails

Cordialement
    `;
    
    // Construction du sujet
    const sujet = 'Simulation de Credit - Resultats et Tableau d\'Amortissement';
    
    // Cr√©ation du lien mailto
    const mailtoLink = `mailto:?subject=${encodeURIComponent(sujet)}&body=${encodeURIComponent(tableauHTML)}`;
    
    // Ouvrir le client email
    window.location.href = mailtoLink;
    
    // Afficher un message d'information
    setTimeout(function(){
      alert('‚úÖ Le PDF a √©t√© t√©l√©charg√© !\n\nüìß Votre client email va s\'ouvrir.\n\nüìé N\'oubliez pas de joindre le fichier PDF "amortissement_scenario1.pdf" depuis votre dossier T√©l√©chargements avant d\'envoyer l\'email.');
    }, 500);
  }, 1000);
}

/**
 * Fonction pour calculer la capacit√© d'emprunt
 */
function calculerCapaciteEmprunt(){
  // Cr√©er une bo√Æte de dialogue modale
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    border: 3px solid rgba(14, 165, 233, 0.6);
    box-shadow: 0 0 30px rgba(14, 165, 233, 0.5);
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
  `;
  
  modalContent.innerHTML = `
    <h2 style="color: #0ea5e9; margin-top: 0; text-align: center;">üí∞ Calculateur de Capacit√© d'Emprunt</h2>
    <p style="color: #64748b; text-align: center; margin-bottom: 20px;">Taux d'endettement maximum : 40%</p>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; color: #0ea5e9; font-weight: bold; margin-bottom: 5px;">Revenus mensuels nets (TND)</label>
      <input type="number" id="revenusMensuels" placeholder="Ex: 2000" style="width: 100%; padding: 12px; border: 2px solid rgba(14, 165, 233, 0.6); border-radius: 10px; font-size: 16px;" />
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; color: #0ea5e9; font-weight: bold; margin-bottom: 5px;">Charges mensuelles (TND)</label>
      <input type="number" id="chargesMensuelles" placeholder="Ex: 300" value="0" style="width: 100%; padding: 12px; border: 2px solid rgba(14, 165, 233, 0.6); border-radius: 10px; font-size: 16px;" />
    </div>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; color: #0ea5e9; font-weight: bold; margin-bottom: 5px;">Dur√©e souhait√©e (mois)</label>
      <input type="number" id="dureeCapacite" placeholder="Ex: 120" value="120" style="width: 100%; padding: 12px; border: 2px solid rgba(14, 165, 233, 0.6); border-radius: 10px; font-size: 16px;" />
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; color: #0ea5e9; font-weight: bold; margin-bottom: 5px;">Taux d'int√©r√™t annuel (%)</label>
      <input type="number" id="tauxCapacite" placeholder="Ex: 5" value="5" step="0.1" style="width: 100%; padding: 12px; border: 2px solid rgba(14, 165, 233, 0.6); border-radius: 10px; font-size: 16px;" />
    </div>
    
    <div id="resultatCapacite" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: none;">
      <h3 style="margin: 0 0 10px 0; text-align: center;">R√©sultat</h3>
      <p style="margin: 5px 0; font-size: 14px;"><strong>Capacit√© d'endettement :</strong> <span id="capaciteEndettement"></span></p>
      <p style="margin: 5px 0; font-size: 14px;"><strong>Mensualit√© maximale :</strong> <span id="mensualiteMax"></span></p>
      <p style="margin: 5px 0; font-size: 18px; text-align: center; margin-top: 15px;"><strong>Montant empruntable :</strong><br><span id="montantEmpruntable" style="font-size: 28px;"></span></p>
    </div>
    
    <div style="display: flex; gap: 10px;">
      <button id="btnCalculerCapacite" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);">‚úÖ Calculer</button>
      <button id="btnUtiliser" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: none; box-shadow: 0 0 15px rgba(14, 165, 233, 0.4);">üîÑ Utiliser</button>
      <button id="btnFermerModal" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);">‚ùå Fermer</button>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Variables pour stocker les r√©sultats
  let montantCalcule = 0;
  let dureeCalculee = 0;
  let tauxCalcule = 0;
  
  // Fonction de calcul
  document.getElementById('btnCalculerCapacite').addEventListener('click', function(){
    const revenus = parseFloat(document.getElementById('revenusMensuels').value);
    const charges = parseFloat(document.getElementById('chargesMensuelles').value) || 0;
    const duree = parseFloat(document.getElementById('dureeCapacite').value);
    const taux = parseFloat(document.getElementById('tauxCapacite').value);
    
    if (!revenus || revenus <= 0) {
      alert('Veuillez saisir vos revenus mensuels.');
      return;
    }
    
    if (!duree || duree <= 0) {
      alert('Veuillez saisir une dur√©e valide.');
      return;
    }
    
    if (!taux || taux < 0) {
      alert('Veuillez saisir un taux d\'int√©r√™t valide.');
      return;
    }
    
    // Calcul de la capacit√© d'endettement (40% des revenus)
    const capaciteEndettement = revenus * 0.40;
    
    // Mensualit√© maximale = capacit√© d'endettement - charges
    const mensualiteMax = capaciteEndettement - charges;
    
    if (mensualiteMax <= 0) {
      alert('Vos charges sont trop √©lev√©es par rapport √† vos revenus. Capacit√© d\'emprunt nulle.');
      return;
    }
    
    // Calcul du montant empruntable
    // Formule : C = M * [(1 - (1 + i)^-n) / i]
    // o√π C = capital, M = mensualit√©, i = taux mensuel, n = nombre de mois
    const tauxMensuel = taux / 100 / 12;
    let montantEmpruntable;
    
    if (tauxMensuel === 0) {
      montantEmpruntable = mensualiteMax * duree;
    } else {
      montantEmpruntable = mensualiteMax * ((1 - Math.pow(1 + tauxMensuel, -duree)) / tauxMensuel);
    }
    
    // Stocker les valeurs pour utilisation ult√©rieure
    montantCalcule = montantEmpruntable;
    dureeCalculee = duree;
    tauxCalcule = taux;
    
    // Afficher les r√©sultats
    document.getElementById('capaciteEndettement').textContent = fmtMoney(capaciteEndettement);
    document.getElementById('mensualiteMax').textContent = fmtMoney(mensualiteMax);
    document.getElementById('montantEmpruntable').textContent = fmtMoney(montantEmpruntable);
    document.getElementById('resultatCapacite').style.display = 'block';
    document.getElementById('btnUtiliser').style.display = 'block';
  });
  
  // Bouton Utiliser : remplit les champs du formulaire principal
  document.getElementById('btnUtiliser').addEventListener('click', function(){
    if (montantCalcule > 0) {
      document.getElementById('capital').value = montantCalcule.toFixed(3);
      document.getElementById('duree').value = dureeCalculee;
      document.getElementById('tauxAnnuel').value = tauxCalcule;
      
      // Calculer automatiquement le taux mensuel
      const tauxMensuel = tauxCalcule / 12;
      document.getElementById('tauxMensuel').value = tauxMensuel.toFixed(6);
      
      // Fermer la modale
      document.body.removeChild(modal);
      
      // Afficher un message de confirmation
      alert('‚úÖ Les valeurs ont √©t√© appliqu√©es ! Cliquez sur "Calculer" pour voir la mensualit√©.');
    }
  });
  
  // Fermer la modale
  document.getElementById('btnFermerModal').addEventListener('click', function(){
    document.body.removeChild(modal);
  });
  
  // Fermer en cliquant sur le fond
  modal.addEventListener('click', function(e){
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  });
}

/**
 * Fonction pour sauvegarder une simulation dans l'historique
 */
function sauvegarderSimulation(){
  const capital = document.getElementById('capital').value;
  const duree = document.getElementById('duree').value;
  const tauxAnnuel = document.getElementById('tauxAnnuel').value;
  const dateDebut = document.getElementById('dateDebut').value;
  const mensualite = document.getElementById('kpiMensualite').textContent;
  const interets = document.getElementById('kpiInterets').textContent;
  
  if (!capital || !duree || !tauxAnnuel || mensualite === '‚Äî') {
    return; // Ne pas sauvegarder si les donn√©es sont incompl√®tes
  }
  
  // R√©cup√©rer l'historique existant
  let historique = JSON.parse(localStorage.getItem('historiqueSimulations') || '[]');
  
  // Cr√©er une nouvelle entr√©e
  const simulation = {
    id: Date.now(),
    date: new Date().toLocaleString('fr-FR'),
    capital: capital,
    duree: duree,
    tauxAnnuel: tauxAnnuel,
    dateDebut: dateDebut,
    mensualite: mensualite,
    interets: interets
  };
  
  // Ajouter au d√©but de l'historique
  historique.unshift(simulation);
  
  // Limiter √† 50 simulations maximum
  if (historique.length > 50) {
    historique = historique.slice(0, 50);
  }
  
  // Sauvegarder dans localStorage
  localStorage.setItem('historiqueSimulations', JSON.stringify(historique));
}

/**
 * Fonction pour afficher l'historique des simulations
 */
function afficherHistorique(){
  // R√©cup√©rer l'historique
  const historique = JSON.parse(localStorage.getItem('historiqueSimulations') || '[]');
  
  // Cr√©er la modale
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    overflow: auto;
    padding: 20px;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    border: 3px solid rgba(245, 158, 11, 0.6);
    box-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
    border-radius: 20px;
    padding: 30px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
  `;
  
  let contenuHTML = `
    <h2 style="color: #f59e0b; margin-top: 0; text-align: center;">üìú Historique des Simulations</h2>
    <p style="color: #64748b; text-align: center; margin-bottom: 20px;">${historique.length} simulation(s) sauvegard√©e(s)</p>
  `;
  
  if (historique.length === 0) {
    contenuHTML += `
      <div style="text-align: center; padding: 40px; color: #64748b;">
        <p style="font-size: 18px;">‚ùå Aucune simulation dans l'historique</p>
        <p>Les simulations seront automatiquement sauvegard√©es apr√®s chaque calcul.</p>
      </div>
    `;
  } else {
    contenuHTML += '<div style="display: flex; flex-direction: column; gap: 15px;">';
    
    historique.forEach((sim, index) => {
      contenuHTML += `
        <div style="background: white; border: 2px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
              <strong style="color: #f59e0b; font-size: 16px;">Simulation #${historique.length - index}</strong>
              <span style="color: #64748b; font-size: 12px; margin-left: 10px;">${sim.date}</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-charger" data-id="${sim.id}" style="padding: 6px 12px; background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold;">üîÑ Charger</button>
              <button class="btn-supprimer" data-id="${sim.id}" style="padding: 6px 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold;">üóëÔ∏è Supprimer</button>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 13px;">
            <div><strong style="color: #0ea5e9;">Capital:</strong> ${sim.capital} TND</div>
            <div><strong style="color: #0ea5e9;">Dur√©e:</strong> ${sim.duree} mois</div>
            <div><strong style="color: #0ea5e9;">Taux:</strong> ${sim.tauxAnnuel}%</div>
            <div><strong style="color: #10b981;">Mensualit√©:</strong> ${sim.mensualite}</div>
            <div><strong style="color: #ef4444;">Int√©r√™ts:</strong> ${sim.interets}</div>
            <div><strong style="color: #64748b;">D√©but:</strong> ${sim.dateDebut || 'Non sp√©cifi√©'}</div>
          </div>
        </div>
      `;
    });
    
    contenuHTML += '</div>';
  }
  
  contenuHTML += `
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button id="btnEffacerHistorique" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);">üóëÔ∏è Effacer tout l'historique</button>
      <button id="btnFermerHistorique" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(100, 116, 139, 0.4);">‚ùå Fermer</button>
    </div>
  `;
  
  modalContent.innerHTML = contenuHTML;
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Attacher les √©v√©nements pour charger une simulation
  const btnsCharger = modalContent.querySelectorAll('.btn-charger');
  btnsCharger.forEach(btn => {
    btn.addEventListener('click', function(){
      const simId = parseInt(this.getAttribute('data-id'));
      const sim = historique.find(s => s.id === simId);
      
      if (sim) {
        // Charger les valeurs dans le formulaire
        document.getElementById('capital').value = sim.capital;
        document.getElementById('duree').value = sim.duree;
        document.getElementById('tauxAnnuel').value = sim.tauxAnnuel;
        document.getElementById('dateDebut').value = sim.dateDebut || '';
        
        // Calculer le taux mensuel
        const tauxMensuel = parseFloat(sim.tauxAnnuel) / 12;
        document.getElementById('tauxMensuel').value = tauxMensuel.toFixed(6);
        
        // Fermer la modale
        document.body.removeChild(modal);
        
        // Afficher un message
        alert('‚úÖ Simulation charg√©e ! Cliquez sur "Calculer" pour voir les r√©sultats.');
      }
    });
  });
  
  // Attacher les √©v√©nements pour supprimer une simulation
  const btnsSupprimer = modalContent.querySelectorAll('.btn-supprimer');
  btnsSupprimer.forEach(btn => {
    btn.addEventListener('click', function(){
      const simId = parseInt(this.getAttribute('data-id'));
      
      if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer cette simulation ?')) {
        // Filtrer l'historique pour supprimer la simulation
        const nouvelHistorique = historique.filter(s => s.id !== simId);
        localStorage.setItem('historiqueSimulations', JSON.stringify(nouvelHistorique));
        
        // Fermer et rouvrir la modale pour rafra√Æchir
        document.body.removeChild(modal);
        afficherHistorique();
      }
    });
  });
  
  // Bouton pour effacer tout l'historique
  const btnEffacer = document.getElementById('btnEffacerHistorique');
  if (btnEffacer) {
    btnEffacer.addEventListener('click', function(){
      if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir effacer TOUT l\'historique ? Cette action est irr√©versible.')) {
        localStorage.removeItem('historiqueSimulations');
        document.body.removeChild(modal);
        alert('‚úÖ Historique effac√© avec succ√®s.');
      }
    });
  }
  
  // Fermer la modale
  const btnFermer = document.getElementById('btnFermerHistorique');
  if (btnFermer) {
    btnFermer.addEventListener('click', function(){
      document.body.removeChild(modal);
    });
  }
  
  // Fermer en cliquant sur le fond
  modal.addEventListener('click', function(e){
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  });
}

// Attacher les √©v√©nements aux boutons
document.addEventListener('DOMContentLoaded', function(){
  const btnEmail = document.getElementById('btnEmail');
  const btnCapacite = document.getElementById('btnCapacite');
  const btnHistorique = document.getElementById('btnHistorique');
  const btnCalcul = document.getElementById('btnCalcul');
  
  if (btnEmail) {
    btnEmail.addEventListener('click', partagerParEmail);
  }
  
  if (btnCapacite) {
    btnCapacite.addEventListener('click', calculerCapaciteEmprunt);
  }
  
  if (btnHistorique) {
    btnHistorique.addEventListener('click', afficherHistorique);
  }
  
  // Sauvegarder automatiquement apr√®s chaque calcul
  if (btnCalcul) {
    const originalCalcul = btnCalcul.onclick;
    btnCalcul.addEventListener('click', function(){
      // Attendre que le calcul soit termin√©
      setTimeout(function(){
        sauvegarderSimulation();
      }, 500);
    });
  }
  
  // Bouton Comparer 3 sc√©narios
  const btnComparer = document.getElementById('btnComparer');
  if (btnComparer) {
    btnComparer.addEventListener('click', comparerScenarios);
  }
});

/**
 * Fonction pour comparer jusqu'√† 3 sc√©narios
 */
function comparerScenarios(){
  // R√©cup√©rer l'historique
  const historique = JSON.parse(localStorage.getItem('historiqueSimulations') || '[]');
  
  if (historique.length === 0) {
    alert('‚ö†Ô∏è Aucune simulation dans l\'historique. Veuillez d\'abord effectuer des simulations.');
    return;
  }
  
  // Cr√©er la modale
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    overflow: auto;
    padding: 20px;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    border: 3px solid rgba(139, 92, 246, 0.6);
    box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
    border-radius: 20px;
    padding: 30px;
    max-width: 1000px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
  `;
  
  let contenuHTML = `
    <h2 style="color: #8b5cf6; margin-top: 0; text-align: center;">üîç Comparaison de Sc√©narios</h2>
    <p style="color: #64748b; text-align: center; margin-bottom: 20px;">S√©lectionnez jusqu'√† 3 simulations √† comparer</p>
  `;
  
  // Afficher la liste des simulations avec des checkboxes
  contenuHTML += '<div style="margin-bottom: 20px; max-height: 300px; overflow-y: auto; border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 10px; padding: 15px;">';
  
  historique.slice(0, 10).forEach((sim, index) => {
    contenuHTML += `
      <div style="margin-bottom: 10px; padding: 10px; background: white; border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 8px;">
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="checkbox" class="sim-checkbox" data-id="${sim.id}" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
          <div style="flex: 1;">
            <strong style="color: #8b5cf6;">Simulation #${historique.length - index}</strong>
            <span style="color: #64748b; font-size: 12px; margin-left: 10px;">${sim.date}</span>
            <div style="font-size: 13px; color: #475569; margin-top: 5px;">
              Capital: ${sim.capital} TND | Dur√©e: ${sim.duree} mois | Taux: ${sim.tauxAnnuel}%
            </div>
          </div>
        </label>
      </div>
    `;
  });
  
  contenuHTML += '</div>';
  
  // Tableau de comparaison (initialement vide)
  contenuHTML += '<div id="tableauComparaison" style="margin-top: 20px;"></div>';
  
  contenuHTML += `
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button id="btnComparer" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);">üîç Comparer</button>
      <button id="btnFermerComparaison" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px rgba(100, 116, 139, 0.4);">‚ùå Fermer</button>
    </div>
  `;
  
  modalContent.innerHTML = contenuHTML;
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // G√©rer les checkboxes (max 3)
  const checkboxes = modalContent.querySelectorAll('.sim-checkbox');
  checkboxes.forEach(cb => {
    cb.addEventListener('change', function(){
      const checked = modalContent.querySelectorAll('.sim-checkbox:checked');
      if (checked.length > 3) {
        this.checked = false;
        alert('‚ö†Ô∏è Vous ne pouvez comparer que 3 sc√©narios maximum.');
      }
    });
  });
  
  // Bouton Comparer
  const btnComparerModal = modalContent.querySelector('#btnComparer');
  btnComparerModal.addEventListener('click', function(){
    const checked = modalContent.querySelectorAll('.sim-checkbox:checked');
    
    if (checked.length < 2) {
      alert('‚ö†Ô∏è Veuillez s√©lectionner au moins 2 sc√©narios √† comparer.');
      return;
    }
    
    // R√©cup√©rer les simulations s√©lectionn√©es
    const selectedIds = Array.from(checked).map(cb => parseInt(cb.getAttribute('data-id')));
    const selectedSims = historique.filter(sim => selectedIds.includes(sim.id));
    
    // G√©n√©rer le tableau de comparaison
    let tableHTML = `
      <h3 style="color: #8b5cf6; text-align: center; margin-bottom: 15px;">R√©sultat de la comparaison</h3>
      <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <thead>
          <tr style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white;">
            <th style="padding: 12px; text-align: left; border: 1px solid rgba(255,255,255,0.2);">Crit√®re</th>
    `;
    
    selectedSims.forEach((sim, index) => {
      const simIndex = historique.findIndex(s => s.id === sim.id);
      tableHTML += `<th style="padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.2);">Sc√©nario #${historique.length - simIndex}</th>`;
    });
    
    tableHTML += `
          </tr>
        </thead>
        <tbody>
          <tr style="background: #f8fafc;">
            <td style="padding: 10px; font-weight: bold; color: #475569; border: 1px solid #e2e8f0;">Date</td>
    `;
    
    selectedSims.forEach(sim => {
      tableHTML += `<td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-size: 12px;">${sim.date}</td>`;
    });
    
    tableHTML += `
          </tr>
          <tr>
            <td style="padding: 10px; font-weight: bold; color: #475569; border: 1px solid #e2e8f0;">Capital emprunt√©</td>
    `;
    
    selectedSims.forEach(sim => {
      tableHTML += `<td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: #0ea5e9; font-weight: bold;">${sim.capital} TND</td>`;
    });
    
    tableHTML += `
          </tr>
          <tr style="background: #f8fafc;">
            <td style="padding: 10px; font-weight: bold; color: #475569; border: 1px solid #e2e8f0;">Dur√©e</td>
    `;
    
    selectedSims.forEach(sim => {
      tableHTML += `<td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: #0ea5e9; font-weight: bold;">${sim.duree} mois</td>`;
    });
    
    tableHTML += `
          </tr>
          <tr>
            <td style="padding: 10px; font-weight: bold; color: #475569; border: 1px solid #e2e8f0;">Taux d'int√©r√™t</td>
    `;
    
    selectedSims.forEach(sim => {
      tableHTML += `<td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: #0ea5e9; font-weight: bold;">${sim.tauxAnnuel}%</td>`;
    });
    
    tableHTML += `
          </tr>
          <tr style="background: #f0fdf4;">
            <td style="padding: 10px; font-weight: bold; color: #475569; border: 1px solid #e2e8f0;">üíµ Mensualit√©</td>
    `;
    
    selectedSims.forEach(sim => {
      tableHTML += `<td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: #10b981; font-weight: bold; font-size: 16px;">${sim.mensualite}</td>`;
    });
    
    tableHTML += `
          </tr>
          <tr style="background: #fef2f2;">
            <td style="padding: 10px; font-weight: bold; color: #475569; border: 1px solid #e2e8f0;">üí∏ Co√ªt total des int√©r√™ts</td>
    `;
    
    selectedSims.forEach(sim => {
      tableHTML += `<td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: #ef4444; font-weight: bold; font-size: 16px;">${sim.interets}</td>`;
    });
    
    tableHTML += `
          </tr>
          <tr style="background: #eff6ff;">
            <td style="padding: 10px; font-weight: bold; color: #475569; border: 1px solid #e2e8f0;">üìä Co√ªt total du cr√©dit</td>
    `;
    
    selectedSims.forEach(sim => {
      // Calculer le co√ªt total (capital + int√©r√™ts)
      const capital = parseFloat(sim.capital.replace(/[^0-9.,]/g, '').replace(',', '.'));
      const interets = parseFloat(sim.interets.replace(/[^0-9.,]/g, '').replace(',', '.'));
      const total = capital + interets;
      tableHTML += `<td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; color: #3b82f6; font-weight: bold; font-size: 16px;">${total.toLocaleString('fr-FR', {minimumFractionDigits: 3, maximumFractionDigits: 3})} TND</td>`;
    });
    
    tableHTML += `
          </tr>
        </tbody>
      </table>
    `;
    
    // Afficher le meilleur sc√©nario
    const mensualites = selectedSims.map(sim => {
      const mensualite = parseFloat(sim.mensualite.replace(/[^0-9.,]/g, '').replace(',', '.'));
      return { sim, mensualite };
    });
    
    const interets = selectedSims.map(sim => {
      const interet = parseFloat(sim.interets.replace(/[^0-9.,]/g, '').replace(',', '.'));
      return { sim, interet };
    });
    
    const meilleurMensualite = mensualites.reduce((min, curr) => curr.mensualite < min.mensualite ? curr : min);
    const meilleurInteret = interets.reduce((min, curr) => curr.interet < min.interet ? curr : min);
    
    const simIndexMensualite = historique.findIndex(s => s.id === meilleurMensualite.sim.id);
    const simIndexInteret = historique.findIndex(s => s.id === meilleurInteret.sim.id);
    
    tableHTML += `
      <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; border-radius: 10px;">
        <h4 style="color: #10b981; margin-top: 0;">‚úÖ Recommandation</h4>
        <p style="margin: 5px 0; color: #475569;"><strong>üíµ Mensualit√© la plus basse :</strong> Sc√©nario #${historique.length - simIndexMensualite} (${meilleurMensualite.sim.mensualite})</p>
        <p style="margin: 5px 0; color: #475569;"><strong>üí∏ Co√ªt total le plus bas :</strong> Sc√©nario #${historique.length - simIndexInteret} (${meilleurInteret.sim.interets})</p>
      </div>
    `;
    
    // Afficher le tableau
    const tableauDiv = modalContent.querySelector('#tableauComparaison');
    tableauDiv.innerHTML = tableHTML;
  });
  
  // Fermer la modale
  const btnFermer = modalContent.querySelector('#btnFermerComparaison');
  btnFermer.addEventListener('click', function(){
    document.body.removeChild(modal);
  });
  
  // Fermer en cliquant sur le fond
  modal.addEventListener('click', function(e){
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  });
}

</script>
<script>
// R√©initialisation aux VALEURS PAR D√âFAUT souhait√©es (capture d'√©cran)
document.addEventListener('DOMContentLoaded', function(){
  const DEFAULTS = {
    capital: '0',
    duree: '1',
    tauxAnnuel: '0'
  };

  function deriveTauxMensuel(ta){
    const n = parseFloat(String(ta).replace(',', '.'));
    if (isFinite(n)) return String(n/12);
    return '';
  }

  const ids = ['capital','tauxAnnuel','tauxMensuel','duree'];
  const fields = {};
  ids.forEach(id => { fields[id] = document.getElementById(id); });

  // Optionnel: √† l'ouverture, imposer ces valeurs par d√©faut si pr√©sentes
  if (fields.capital) fields.capital.value = DEFAULTS.capital;
  if (fields.duree) fields.duree.value = DEFAULTS.duree;
  if (fields.tauxAnnuel) fields.tauxAnnuel.value = DEFAULTS.tauxAnnuel;
  if (fields.tauxMensuel) fields.tauxMensuel.value = deriveTauxMensuel(DEFAULTS.tauxAnnuel);

  function resetAll(){
    if (fields.capital) fields.capital.value = DEFAULTS.capital;
    if (fields.duree) fields.duree.value = DEFAULTS.duree;
    if (fields.tauxAnnuel) fields.tauxAnnuel.value = DEFAULTS.tauxAnnuel;
    if (fields.tauxMensuel) fields.tauxMensuel.value = deriveTauxMensuel(DEFAULTS.tauxAnnuel);

    // Nettoie les KPIs
    const kpiM = document.getElementById('kpiMensualite');
    const kpiI = document.getElementById('kpiInterets');
    if (kpiM) kpiM.textContent = '‚Äî';
    if (kpiI) kpiI.textContent = '‚Äî';

    // Alerte/avertissement
    const warn = document.getElementById('warnDuree');
    if (warn) warn.textContent = '';

    // Vide le tableau d'amortissement
    const tbody = document.querySelector('#table tbody');
    if (tbody) tbody.innerHTML = '';
  }

  // Raccordement du bouton R√©initialiser
  const btnReset = document.getElementById('btnReset') 
                || document.querySelector('button[type="reset"]') 
                || Array.from(document.querySelectorAll('button')).find(b => /r√©initialiser/i.test(b.textContent));
  if (btnReset){
    btnReset.addEventListener('click', function(e){
      e.preventDefault();
      resetAll();
    });
  }
});
</script>
<script>
// Activation du mode sombre/clair via l'interrupteur
document.addEventListener('DOMContentLoaded', function(){
  const themeToggle = document.getElementById('themeToggle');
  // Applique le th√®me sauvegard√© √† l'ouverture
  const savedTheme = localStorage.getItem('theme');
  if(savedTheme === 'dark'){
    document.body.classList.add('dark');
    if (themeToggle) themeToggle.checked = true;
  }
  if(themeToggle){
    themeToggle.addEventListener('change', function(){
      if (this.checked){
        document.body.classList.add('dark');
        localStorage.setItem('theme','dark');
      } else {
        document.body.classList.remove('dark');
        localStorage.setItem('theme','light');
      }
      // Met √† jour les graphiques pour appliquer les nouvelles couleurs en fonction du th√®me
      // Si les graphiques existent (sc√©nario¬†1 ou sc√©nario¬†2), ils seront rafra√Æchis avec des couleurs adapt√©es.
      try {
        if (typeof updateChart === 'function') {
          updateChart();
        }
        if (typeof updateChart2 === 'function') {
          updateChart2();
        }
      } catch (e) {}
    });
  }
});
</script>
</body>
</html>
